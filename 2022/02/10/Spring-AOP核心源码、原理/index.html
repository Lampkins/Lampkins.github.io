<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="renderer" content="webkit">

  
  <title>Spring AOP核心源码、原理 | 博客</title>

  <link rel="shortcut icon" href="/images/favicon.png">
  <link rel="alternate" href="/atom.xml" title="博客" type="application/atom+xml">
  <meta name="description" content="¶ Advice通知相关的类  通知包装器 负责将各种非MethodInterceptor类型的通知(Advice)包装为MethodInterceptor类型。   MethodBeforeAdviceInterceptor 1234567891011121314151617public class MethodBeforeAdviceInterceptor implements MethodI">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring AOP核心源码、原理">
<meta property="og:url" content="http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="博客">
<meta property="og:description" content="¶ Advice通知相关的类  通知包装器 负责将各种非MethodInterceptor类型的通知(Advice)包装为MethodInterceptor类型。   MethodBeforeAdviceInterceptor 1234567891011121314151617public class MethodBeforeAdviceInterceptor implements MethodI">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220706231214818.png">
<meta property="og:image" content="http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220707003232219.png">
<meta property="og:image" content="http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220707003907469.png">
<meta property="og:image" content="http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220707005628299.png">
<meta property="og:image" content="http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220707004544447.png">
<meta property="og:image" content="http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220707230535133.png">
<meta property="og:image" content="http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220707010100510.png">
<meta property="og:image" content="http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220708212633217.png">
<meta property="og:image" content="http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220708234953751.png">
<meta property="og:image" content="http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220716155002.png">
<meta property="article:published_time" content="2022-02-10T11:02:01.000Z">
<meta property="article:modified_time" content="2022-10-13T02:43:07.673Z">
<meta property="article:author" content="Lampkins">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220706231214818.png">

  <meta name="keywords" content=",Spring">
  <meta name="format-detection" content="telephone=no,email=no">
  <meta name="theme-color" content="#9C27B0">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="博客">
  <meta name="msapplication-starturl" content="http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/">
  <meta name="msapplication-navbutton-color" content="#9C27B0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="博客">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/images/favicon.png">

  
    <link rel="canonical" href="http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/">
  

  
  

  
  
  

  
<link rel="stylesheet" href="/css/mdui.css">
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/custom.css">

<meta name="generator" content="Hexo 5.2.0"></head>
<body class="mdui-appbar-with-toolbar mdui-theme-primary-blue-grey mdui-theme-accent-blue">
  <script>var a=localStorage.getItem("mdui-theme-layout-dark");if(a){document.getElementsByTagName("body")[0].className+=" mdui-theme-layout-dark"};</script>
  <script>var a=localStorage.getItem("mdui-drawer-close");if(!a){document.getElementsByTagName("body")[0].className+=" mdui-drawer-body-left"};</script>
  <header id="header" class="mdui-appbar mdui-appbar-fixed mdui-appbar-scroll-hide mdui-appbar-inset">
  <div class="mdui-toolbar mdui-color-theme">
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="mdui-icon material-icons">menu</i></a>
    <a href="/" class="mdui-typo-headline">博客</a>
    <div class="mdui-toolbar-spacer"></div>
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: '搜索'}"><i class="mdui-icon material-icons">search</i></a>
    <a href="/atom.xml" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: 'RSS'}"><i class="mdui-icon material-icons">rss_feed</i></a>
    <a id="mode" href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: 'D/N'}"><i class="mdui-icon material-icons">brightness_5</i></a>
  </div>
</header>
<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字">
    </div>
    <div class="search-result" data-resource="/search.xml"></div>
  
</div>
  <aside id="sidebar" class="mdui-drawer mdui-drawer-full-height mdui-shadow-3">
  <script>var a=localStorage.getItem("mdui-drawer-close");if(a){document.getElementById("sidebar").className+=" mdui-drawer-close"};</script>
  <div class="mdui-grid-tile">
    <img src="/images/banner1.jpg" style="height: auto;">
    <img src="/images/avatar1.jpg" class="avatar-animation" style="position: absolute; top: 10%; left: 24px; width: 64px; height: 64px; border: 2px solid #fff; border-radius: 50%;">
    <div class="mdui-grid-tile-actions">
      <div class="mdui-grid-tile-text">
        <div class="mdui-grid-tile-title">Lampkins</div>
        <div class="mdui-grid-tile-subtitle"><i class="mdui-icon material-icons">art_track</i>Creator by ❤️</div>
      </div>
      
        <div class="mdui-grid-tile-buttons">
          <a href="mailto:arivins_lau@foxmail.com" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: 'arivins_lau@foxmail.com'}"><i class="mdui-icon material-icons">email</i></a>
        </div>
      
    </div>
  </div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    <a href="/" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-blue">home</i>
      <div class="mdui-list-item-content">主页</div>
    </a>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-deep-orange">archive</i>
        <div class="mdui-list-item-content">归档</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/archives/2022/02/">二月 2022<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/08/">八月 2021<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/11/">十一月 2020<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/10/">十月 2020<span class="mdui-ripple sidebar_archives-count">8</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/09/">九月 2020<span class="mdui-ripple sidebar_archives-count">4</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-green">class</i>
        <div class="mdui-list-item-content">分类</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/categories/Java/">Java<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/%E6%8A%80%E6%9C%AF/">技术<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库<span class="mdui-ripple sidebar_archives-count">10</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">MySQL性能优化<span class="mdui-ripple sidebar_archives-count">8</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/%E6%B5%8B%E8%AF%95/">测试<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/%E9%98%BF%E9%87%8C%E4%BA%91/">阿里云<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-brown">bookmark</i>
        <div class="mdui-list-item-content">标签</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/tags/ACID/" rel="tag">ACID<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/B-%E6%A0%91/" rel="tag">B+树<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/B%E6%A0%91/" rel="tag">B树<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/JMM/" rel="tag">JMM<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/JVM/" rel="tag">JVM<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/Java/" rel="tag">Java<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/Java%E9%94%81/" rel="tag">Java锁<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/MySQL/" rel="tag">MySQL<span class="mdui-ripple sidebar_archives-count">8</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/Redis/" rel="tag">Redis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/Spring/" rel="tag">Spring<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/markdown/" rel="tag">markdown<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/%E4%BA%8B%E5%8A%A1/" rel="tag">事务<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/%E4%BC%98%E5%8C%96/" rel="tag">优化<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86/" rel="tag">日志采集<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/%E7%B4%A2%E5%BC%95/" rel="tag">索引<span class="mdui-ripple sidebar_archives-count">8</span></a>
        
      </div>
    </div>
    <a href="/about" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-purple">person</i>
      <div class="mdui-list-item-content">关于</div>
    </a>
  </div>

  <div class="mdui-divider"></div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    
      <a href="/tagcloud" class="mdui-list-item mdui-ripple">标签云</a>
    
      <a href="/gallery" class="mdui-list-item mdui-ripple">画廊</a>
    
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <div class="mdui-list-item-content">友情链接</div>
        <i class="mdui-list-item-icon mdui-icon material-icons">link</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
          <a href="/pdf/简历.pdf" target="_blank" class="mdui-list-item mdui-p-l-2 mdui-text-color-theme-accent mdui-ripple" style="justify-content: center;">个人简历</a>
        
          <a href="https://imgchr.com/3312862586" target="_blank" class="mdui-list-item mdui-p-l-2 mdui-text-color-theme-accent mdui-ripple" style="justify-content: center;">路过图床</a>
        
          <a href="https://github.com/Lampkins/Lampkins.github.io" target="_blank" class="mdui-list-item mdui-p-l-2 mdui-text-color-theme-accent mdui-ripple" style="justify-content: center;">博客托管</a>
        
        
      </div>
    </div>
  </div>
</aside>
  <main id="main" class="mdui-m-t-5 fadeIn animated">
  
<link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css">

  <style>#main article .mdui-card-content .center-block{display:block!important;margin-right:auto!important;margin-left:auto!important}</style>
  <article class="mdui-card mdui-m-b-5" style="margin-top: -40px !important;">
    <header class="mdui-card-media">
      <img src="/images/random/material-7.png" style="max-height: 240px;">
      <div class="mdui-card-media-covered">
        <div class="mdui-card-primary">
          <div class="mdui-card-primary-title">Spring AOP核心源码、原理</div>
          <div class="mdui-card-primary-subtitle">
            
            <i class="iconfont">&#xe697;</i> 2022-02-10 / <i class="iconfont">&#xe601;</i> Lampkins &nbsp;&nbsp; <span id="busuanzi_container_page_pv" style="display: none;"><i class="iconfont">&#xe7fd;</i> <span id="busuanzi_value_page_pv"></span></span>
          </div>
        </div>
      </div>
      <div class="mdui-card-menu">
        
          <button class="mdui-btn mdui-btn-icon mdui-text-color-white" mdui-menu="{target: '#qrcode', align: 'right'}"><i class="mdui-icon material-icons">devices</i></button>
          <ul class="mdui-menu" id="qrcode">
            
              <li class="mdui-menu-item"><a class="mdui-text-center mdui-ripple">发送到手机</a></li>
            
            <li class="mdui-menu-item" disabled>
              
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASYAAAEmCAAAAADqr2IGAAAELElEQVR42u3aS07kQBAFQO5/aWaLhNq8l2UGnEStULex3VGLyt/buxWsNwSYMGHChAmThQkTJky/nuktXh+v/3yHV99+fsr1J9dvlfxvfrdX98eECRMmTPuYvjgag1d89aLXcO3nyX9dkyW/ERMmTJgwbWVKgoDkha7hkuvztzoPDjBhwoQJE6b8QL2+sj3UowT1OKnGhAkTJkyYTkqxCVl7hxYUEyZMmDBhqgugwdGeMJ03PqMRnP9fC8eECRMmTL+MaTa486y/f2y+CRMmTJgw/SjTyfrugZ4kZZ2FI9Gvw4QJEyZMK5iSYZo8UMgHT/ODOU+A20/quAkTJkyYMK1gmj0mDxruSrlnKXoRmmDChAkTpnVM7WOuH5yP+JygF4M4ZSiDCRMmTJh2MCUF2VmJdhZ2tMXfZKuGW4IJEyZMmFYwJTfKH5OEAvkGnLQ822AFEyZMmDBtZcofNmsW3nVg5zRtq7WOmzBhwoQJ06OY2qHS9tuTzci/bcvQN7QzMWHChAnTQ5iKA/I43W0T3ZPScxt2RO1MTJgwYcL0cKZ89DO5sk1623vmiHkqjgkTJkyYtjLlpdJZoNC2Etv75GlzHrhgwoQJE6YdTEmb8KStOEuGz8d6ckpMmDBhwrSbKWn4tY/Jg4O2xDwbGMq3GRMmTJgw7WPKj/A8RJgdxu0TT+4fbQwmTJgwYVrB1B7Yeak0aW3mJeMkuZ0l2C+vxIQJEyZMK5ja1mDegJw1NfMktuWr03VMmDBhwrSCqX2htonYcucl42Rj2mIxJkyYMGHax5S3Hu9KOO8NFGaF4ygkwoQJEyZM65jagZikbHr++fVhf1cAMez6YsKECROmX8+UY+UF1nZ0JglK8lJv23YdVggwYcKECdNDmPKBm5Yyv75NffMtnIUCmDBhwoRpE1PSDmwp8wDi5E1OSrrRm2DChAkTpkVMbcF01iZM2pA5XAtabyQmTJgwYVrBdPJy+RE+O+zf49WO8kRJMiZMmDBhWsF0gjILJvJkeDagU5Rxr++GCRMmTJgWMZ2kiyfl1NlIUP6z8wR7WCHAhAkTJkwPYZqVbu8dP501Ms9boZgwYcKE6S8wtclwXiq9NxTIr5+xYsKECROmrUznw53npeGTkGKWlmPChAkTpr/A1N4iSVxnPy8vLt+bnGPChAkTpt1M7Zolt3eFCLPxnfytMGHChAnTPqbzQzo/bq+DjHwbZo3M5EpMmDBhwrSVqW1tto/PG5N5m3N22BdbiwkTJkyY1jElBdxZy7ANLGZDRSctT0yYMGHChCkJIPJW6Enietcoz3BwBxMmTJgwrWbKD/u70ubzdumsuIwJEyZMmPYx5UXVdrzmroJyvjGzMAITJkyYMG1l+o7BndlR3RaRTzb4i//FhAkTJkwrmCxMmDBhwoQJk4UJEyZMj1r/ADCQAWBQBuhaAAAAAElFTkSuQmCC">
              
            </li>
          </ul>
        
        
          <button class="mdui-btn mdui-btn-icon mdui-text-color-white" mdui-menu="{target: '#share_menu', align: 'right'}"><i class="mdui-icon material-icons">share</i></button>
          <ul class="mdui-menu" id="share_menu">
            <li class="mdui-menu-item">
              <a href="http://service.weibo.com/share/share.php?appkey=&title=Spring AOP核心源码、原理&url=http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/&pic=http://lampkins.gitee.io/images/favicon.png&searchPic=false&style=simple" target="_blank" class="mdui-ripple">分享到 Weibo</a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://twitter.com/intent/tweet?text=Spring AOP核心源码、原理&url=http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/&via=Lampkins" target="_blank" class="mdui-ripple">分享到 Twitter</a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://www.facebook.com/sharer/sharer.php?u=http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/" target="_blank" class="mdui-ripple">分享到 Facebook</a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://plus.google.com/share?url=http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/" target="_blank" class="mdui-ripple">分享到 Google+</a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/&title=Spring AOP核心源码、原理" target="_blank" class="mdui-ripple">分享到 LinkedIn</a>
            </li>
            <li class="mdui-menu-item">
              <a href="http://connect.qq.com/widget/shareqq/index.html?site=博客&title=Spring AOP核心源码、原理&pics=http://lampkins.gitee.io/images/favicon.png&url=http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/" target="_blank" class="mdui-ripple">分享到 QQ</a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://telegram.me/share/url?url=http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/&text=Spring AOP核心源码、原理" target="_blank" class="mdui-ripple">分享到 Telegram</a>
            </li>
          </ul>
        
      </div>
    </header>
    <div class="mdui-card-content mdui-typo">
      <h2 id="Advice%E9%80%9A%E7%9F%A5%E7%9B%B8%E5%85%B3%E7%9A%84%E7%B1%BB"><a class="header-anchor" href="#Advice%E9%80%9A%E7%9F%A5%E7%9B%B8%E5%85%B3%E7%9A%84%E7%B1%BB">¶</a> Advice通知相关的类</h2>
<p><img src="/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220706231214818.png" alt="image-20220706231214818"></p>
<p><strong>通知包装器</strong></p>
<p>负责将各种非MethodInterceptor类型的通知(Advice)包装为MethodInterceptor类型。</p>
<ul>
<li>
<p>MethodBeforeAdviceInterceptor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodBeforeAdviceInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span>, <span class="title">BeforeAdvice</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> MethodBeforeAdvice advice;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">MethodBeforeAdviceInterceptor</span><span class="params">(MethodBeforeAdvice advice)</span> </span>&#123;</span><br><span class="line">      Assert.notNull(advice, <span class="string">&quot;Advice must not be null&quot;</span>);</span><br><span class="line">      <span class="keyword">this</span>.advice = advice;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation mi)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">      <span class="comment">//负责调用前置通知的方法</span></span><br><span class="line">      <span class="keyword">this</span>.advice.before(mi.getMethod(), mi.getArguments(), mi.getThis());</span><br><span class="line">      <span class="comment">//继续执行方法调用链</span></span><br><span class="line">      <span class="keyword">return</span> mi.proceed();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>AfterReturningAdviceInterceptor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AfterReturningAdviceInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span>, <span class="title">AfterAdvice</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> AfterReturningAdvice advice;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">AfterReturningAdviceInterceptor</span><span class="params">(AfterReturningAdvice advice)</span> </span>&#123;</span><br><span class="line">		Assert.notNull(advice, <span class="string">&quot;Advice must not be null&quot;</span>);</span><br><span class="line">		<span class="keyword">this</span>.advice = advice;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation mi)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    	 <span class="comment">//先执行方法调用链,可以获取目标方法的执行结果</span></span><br><span class="line">		Object retVal = mi.proceed();</span><br><span class="line">		<span class="comment">//执行后置通知</span></span><br><span class="line">		<span class="keyword">this</span>.advice.afterReturning(retVal, mi.getMethod(), mi.getArguments(), mi.getThis());</span><br><span class="line">		<span class="keyword">return</span> retVal;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ThrowsAdviceInterceptor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThrowsAdviceInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span>, <span class="title">AfterAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String AFTER_THROWING = <span class="string">&quot;afterThrowing&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(ThrowsAdviceInterceptor.class);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Object throwsAdvice;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/** Methods on throws advice, keyed by exception class. */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Method&gt; exceptionHandlerMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ThrowsAdviceInterceptor</span><span class="params">(Object throwsAdvice)</span> </span>&#123;</span><br><span class="line">		Assert.notNull(throwsAdvice, <span class="string">&quot;Advice must not be null&quot;</span>);</span><br><span class="line">		<span class="keyword">this</span>.throwsAdvice = throwsAdvice;</span><br><span class="line">		<span class="comment">//获取异常通知中定义的所有方法（public、默认的、protected、private）</span></span><br><span class="line">		Method[] methods = throwsAdvice.getClass().getMethods();</span><br><span class="line">        <span class="comment">//轮询methods</span></span><br><span class="line">		<span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">             <span class="comment">//方法名称为afterThrowing &amp;&amp; 方法参数为1或者4</span></span><br><span class="line">			<span class="keyword">if</span> (method.getName().equals(AFTER_THROWING) &amp;&amp;</span><br><span class="line">					(method.getParameterCount() == <span class="number">1</span> || method.getParameterCount() == <span class="number">4</span>)) &#123;</span><br><span class="line">				<span class="comment">//获取方法的最后一个参数类型</span></span><br><span class="line">				Class&lt;?&gt; throwableParam = method.getParameterTypes()[method.getParameterCount() - <span class="number">1</span>];</span><br><span class="line">                 <span class="comment">//判断方法参数类型是不是Throwable类型的</span></span><br><span class="line">				<span class="keyword">if</span> (Throwable.class.isAssignableFrom(throwableParam)) &#123;</span><br><span class="line">					<span class="comment">// 缓存异常处理方法到map中（异常类型-&gt;异常处理方法）</span></span><br><span class="line">					<span class="keyword">this</span>.exceptionHandlerMap.put(throwableParam, method);</span><br><span class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">						logger.debug(<span class="string">&quot;Found exception handler method on throws advice: &quot;</span> + method);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 不能为空，最少要有一个异常处理方法</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.exceptionHandlerMap.isEmpty()) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">					<span class="string">&quot;At least one handler method must be found in class [&quot;</span> + throwsAdvice.getClass() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 获取异常通知中自定义的处理异常方法的数量</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getHandlerMethodCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.exceptionHandlerMap.size();</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation mi)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="comment">//调用通知链</span></span><br><span class="line">			<span class="keyword">return</span> mi.proceed();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">             <span class="comment">//获取异常通知中自定义的处理异常的方法</span></span><br><span class="line">			Method handlerMethod = getExceptionHandler(ex);</span><br><span class="line">			<span class="keyword">if</span> (handlerMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="comment">//调用异常处理方法</span></span><br><span class="line">				invokeHandlerMethod(mi, ex, handlerMethod);</span><br><span class="line">			&#125;</span><br><span class="line">             <span class="comment">//继续向外抛出异常</span></span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 获取throwsAdvice中处理exception参数指定的异常的方法</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> Method <span class="title">getExceptionHandler</span><span class="params">(Throwable exception)</span> </span>&#123;</span><br><span class="line">         <span class="comment">//获取异常类型</span></span><br><span class="line">		Class&lt;?&gt; exceptionClass = exception.getClass();</span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">&quot;Trying to find handler for exception of type [&quot;</span> + exceptionClass.getName() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//从缓存中获取异常类型对应的方法</span></span><br><span class="line">		Method handler = <span class="keyword">this</span>.exceptionHandlerMap.get(exceptionClass);</span><br><span class="line">		<span class="comment">// 循环获取异常的父类型及对应缓存的处理方法</span></span><br><span class="line">		<span class="keyword">while</span> (handler == <span class="keyword">null</span> &amp;&amp; exceptionClass != Throwable.class) &#123;</span><br><span class="line">			exceptionClass = exceptionClass.getSuperclass();</span><br><span class="line">			handler = <span class="keyword">this</span>.exceptionHandlerMap.get(exceptionClass);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (handler != <span class="keyword">null</span> &amp;&amp; logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">&quot;Found handler for exception of type [&quot;</span> + exceptionClass.getName() + <span class="string">&quot;]: &quot;</span> + handler);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> handler;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//通过反射调用异常通知中的异常方法</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeHandlerMethod</span><span class="params">(MethodInvocation mi, Throwable ex, Method method)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		Object[] handlerArgs;</span><br><span class="line">         <span class="comment">//若只有1个参数，参数为：异常对象</span></span><br><span class="line">		<span class="keyword">if</span> (method.getParameterCount() == <span class="number">1</span>) &#123;</span><br><span class="line">			handlerArgs = <span class="keyword">new</span> Object[] &#123;ex&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">//4个参数（方法、方法请求参数、目标对象、异常对象）</span></span><br><span class="line">			handlerArgs = <span class="keyword">new</span> Object[] &#123;mi.getMethod(), mi.getArguments(), mi.getThis(), ex&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="comment">//通过反射调用异常通知中的方法</span></span><br><span class="line">			method.invoke(<span class="keyword">this</span>.throwsAdvice, handlerArgs);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (InvocationTargetException targetEx) &#123;</span><br><span class="line">			<span class="keyword">throw</span> targetEx.getTargetException();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="PointCut%E5%88%87%E5%85%A5%E7%82%B9%E7%9B%B8%E5%85%B3%E7%B1%BB"><a class="header-anchor" href="#PointCut%E5%88%87%E5%85%A5%E7%82%B9%E7%9B%B8%E5%85%B3%E7%B1%BB">¶</a> PointCut切入点相关类</h2>
<p><img src="/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220707003232219.png" alt="image-20220707003232219"></p>
<p>MethodMatcher过滤流程：</p>
<ul>
<li>
<pre><code>        调用matches(Method method, Class&lt;?&gt; targetClass)方法，验证方法是否匹配
</code></pre>
</li>
<li>
<pre><code>        isRuntime方法(动态匹配)是否为true，如果为false，则以第一步的结果为准，否则继续向下
</code></pre>
</li>
<li>
<pre><code>        调用matches(Method method, Class&lt;?&gt; targetClass, Object... args)方法继续验证，可以对目标方法传入的参数进行校验。
</code></pre>
</li>
</ul>
<h2 id="Advisor%E9%A1%BE%E9%97%AE"><a class="header-anchor" href="#Advisor%E9%A1%BE%E9%97%AE">¶</a> Advisor顾问</h2>
<p><img src="/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220707003907469.png" alt="image-20220707003907469"></p>
<ul>
<li>DefaultPointcutAdvisor类：里面定义了2个属性：pointcut和advisor，由使用者指定</li>
<li>IntroductionAdvisor接口：可以给目标类引入更多接口的功能</li>
</ul>
<h2 id="%E4%BB%A3%E7%90%86%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><a class="header-anchor" href="#%E4%BB%A3%E7%90%86%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">¶</a> 代理创建过程源码解析</h2>
<p><strong>创建代理3大步骤：</strong></p>
<h3 id="1.%20%E5%88%9B%E5%BB%BA%E4%BB%A3%E7%90%86%E6%89%80%E9%9C%80%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><a class="header-anchor" href="#1.%20%E5%88%9B%E5%BB%BA%E4%BB%A3%E7%90%86%E6%89%80%E9%9C%80%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE">¶</a> 1. 创建代理所需参数配置</h3>
<p><img src="/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220707005628299.png" alt="image-20220707005628299"></p>
<h3 id="2.%20%E6%A0%B9%E6%8D%AE%E9%85%8D%E7%BD%AE%E8%8E%B7%E5%8F%96AopProxy%E5%AF%B9%E8%B1%A1"><a class="header-anchor" href="#2.%20%E6%A0%B9%E6%8D%AE%E9%85%8D%E7%BD%AE%E8%8E%B7%E5%8F%96AopProxy%E5%AF%B9%E8%B1%A1">¶</a> 2. 根据配置获取AopProxy对象</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建AopProxy使用了简单工厂模式 </span></span><br><span class="line">AopProxyFactory aopProxyFactory = <span class="keyword">new</span> DefaultAopProxyFactory(); </span><br><span class="line"><span class="comment">//通过AopProxy工厂获取AopProxy对象 </span></span><br><span class="line">AopProxy aopProxy = aopProxyFactory.createAopProxy(advisedSupport);</span><br></pre></td></tr></table></figure>
<p>此阶段会根据AdvisedSupport中配置信息，判断具体是采用cglib的方式还是采用jdk动态代理的方式获取代理对象</p>
<p><img src="/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220707004544447.png" alt="image-20220707004544447"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 默认AopProxyFactory实现，创建CGLIB代理或JDK动态代理。 </span></span><br><span class="line"><span class="comment">* 对于给定的AdvisedSupport实例，以下条件为真，则创建一个CGLIB代理: </span></span><br><span class="line"><span class="comment">* optimize = true || proxyTargetClass = true || 未指定代理接口 </span></span><br><span class="line"><span class="comment">* 通常，指定proxyTargetClass来强制执行CGLIB代理，或者指定一个或多个接口来使用JDK动态代理。 </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultAopProxyFactory</span> <span class="keyword">implements</span> <span class="title">AopProxyFactory</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> AopProxy <span class="title">createAopProxy</span><span class="params">(AdvisedSupport config)</span> <span class="keyword">throws</span> AopConfigException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (config.isOptimize() || config.isProxyTargetClass() || hasNoUserSuppliedProxyInterfaces(config)) &#123;</span><br><span class="line">         Class&lt;?&gt; targetClass = config.getTargetClass();</span><br><span class="line">         <span class="keyword">if</span> (targetClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">&quot;TargetSource cannot determine target class: &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;Either an interface or a target is required for proxy creation.&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">		<span class="comment">//如果被代理的类为接口 或者 被代理的类是jdk动态代理创建代理类，则采用JdkDynamicAopProxy的方式，否则采用cglib代理的方式</span></span><br><span class="line">         <span class="keyword">if</span> (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JdkDynamicAopProxy(config);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> ObjenesisCglibAopProxy(config);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> JdkDynamicAopProxy(config);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 确定所提供的AdvisedSupport是否只指定了SpringProxy接口(或者根本没有指定代理接口)</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasNoUserSuppliedProxyInterfaces</span><span class="params">(AdvisedSupport config)</span> </span>&#123;</span><br><span class="line">      Class&lt;?&gt;[] ifcs = config.getProxiedInterfaces();</span><br><span class="line">      <span class="keyword">return</span> (ifcs.length == <span class="number">0</span> || (ifcs.length == <span class="number">1</span> &amp;&amp; SpringProxy.class.isAssignableFrom(ifcs[<span class="number">0</span>])));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3.%20%E9%80%9A%E8%BF%87AopProxy%E5%88%9B%E5%BB%BA%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1"><a class="header-anchor" href="#3.%20%E9%80%9A%E8%BF%87AopProxy%E5%88%9B%E5%BB%BA%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1">¶</a> 3. 通过AopProxy创建代理对象</h3>
<p>AopProxy.getProxy</p>
<ul>
<li>
<p>JdkDynamicAopProxy：以jdk动态代理的方式创建代理</p>
</li>
<li>
<p>ObjenesisCglibAopProxy：以cglib的方式创建动态代理</p>
</li>
</ul>
<h4 id="JdkDynamicAopProxy%E7%B1%BB"><a class="header-anchor" href="#JdkDynamicAopProxy%E7%B1%BB">¶</a> <strong>JdkDynamicAopProxy类</strong></h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkDynamicAopProxy</span> <span class="keyword">implements</span> <span class="title">AopProxy</span>, <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** use serialVersionUID from Spring 1.2 for interoperability. */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5531744639992436476L</span>;</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">/** We use a static Log to avoid serialization issues. */</span></span><br><span class="line"> 	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(JdkDynamicAopProxy.class);</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">//代理的配置信息</span></span><br><span class="line"> 	<span class="keyword">private</span> <span class="keyword">final</span> AdvisedSupport advised;</span><br><span class="line"></span><br><span class="line"> 	<span class="comment">//需要被代理的接口中是否定义了equals方法</span></span><br><span class="line"> 	<span class="keyword">private</span> <span class="keyword">boolean</span> equalsDefined;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//需要被代理的接口中是否定义了hashCode方法</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> hashCodeDefined;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//通过AdvisedSupport创建实例</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">JdkDynamicAopProxy</span><span class="params">(AdvisedSupport config)</span> <span class="keyword">throws</span> AopConfigException </span>&#123;</span><br><span class="line">		Assert.notNull(config, <span class="string">&quot;AdvisedSupport must not be null&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (config.getAdvisors().length == <span class="number">0</span> &amp;&amp; config.getTargetSource() == AdvisedSupport.EMPTY_TARGET_SOURCE) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">&quot;No advisors and no TargetSource specified&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.advised = config;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//生成一个代理对象</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> getProxy(ClassUtils.getDefaultClassLoader());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">&quot;Creating JDK dynamic proxy: &quot;</span> + <span class="keyword">this</span>.advised.getTargetSource());</span><br><span class="line">		&#125;</span><br><span class="line">         <span class="comment">// @0：根据advised的信息获取代理需要被代理的所有接口列表</span></span><br><span class="line">         <span class="comment">// [开发者硬编码指定的需要被代理的接口列表,SpringProxy,Advised,DecoratingProxy]</span></span><br><span class="line">		Class&lt;?&gt;[] proxiedInterfaces = AopProxyUtils.completeProxiedInterfaces(<span class="keyword">this</span>.advised, <span class="keyword">true</span>);</span><br><span class="line">		<span class="comment">//查找被代理的接口中是否定义了equals、hashCode方法</span></span><br><span class="line">         findDefinedEqualsAndHashCodeMethods(proxiedInterfaces);</span><br><span class="line">         <span class="comment">//通过jdk动态代理创建代理对象，注意最后一个参数是this表示当前类，当前类是InvocationHandler类型的，当调用代理对象的任何方法的时候都会被被当前类的 invoke 方法处理 */</span></span><br><span class="line">		<span class="keyword">return</span> Proxy.newProxyInstance(classLoader, proxiedInterfaces, <span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//查找被代理的接口中是否定义了equals、hashCode方法</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findDefinedEqualsAndHashCodeMethods</span><span class="params">(Class&lt;?&gt;[] proxiedInterfaces)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (Class&lt;?&gt; proxiedInterface : proxiedInterfaces) &#123;</span><br><span class="line">			Method[] methods = proxiedInterface.getDeclaredMethods();</span><br><span class="line">			<span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">				<span class="keyword">if</span> (AopUtils.isEqualsMethod(method)) &#123;</span><br><span class="line">					<span class="keyword">this</span>.equalsDefined = <span class="keyword">true</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (AopUtils.isHashCodeMethod(method)) &#123;</span><br><span class="line">					<span class="keyword">this</span>.hashCodeDefined = <span class="keyword">true</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (<span class="keyword">this</span>.equalsDefined &amp;&amp; <span class="keyword">this</span>.hashCodeDefined) &#123;</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//当在程序中调用代理对象的任何方法，最终都会被下面这个invoke方法处理</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		Object oldProxy = <span class="keyword">null</span>;</span><br><span class="line">         <span class="comment">//用来标记是否需要将代理对象暴露在ThreadLocal中</span></span><br><span class="line">		<span class="keyword">boolean</span> setProxyContext = <span class="keyword">false</span>;</span><br><span class="line">		<span class="comment">//获取目标源</span></span><br><span class="line">		TargetSource targetSource = <span class="keyword">this</span>.advised.targetSource;</span><br><span class="line">         <span class="comment">//目标对象</span></span><br><span class="line">		Object target = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">             <span class="comment">//处理equals方法：被代理的接口中没有定义equals方法 &amp;&amp; 当前调用是equals方法</span></span><br><span class="line">			<span class="keyword">if</span> (!<span class="keyword">this</span>.equalsDefined &amp;&amp; AopUtils.isEqualsMethod(method)) &#123;</span><br><span class="line">				<span class="comment">// 直接调用当前类中的equals方法</span></span><br><span class="line">				<span class="keyword">return</span> equals(args[<span class="number">0</span>]);</span><br><span class="line">			&#125;</span><br><span class="line">             <span class="comment">// 处理hashCode方法：被代理的接口中没有定义hashCode方法 &amp;&amp; 当前调用是 hashCode方法</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.hashCodeDefined &amp;&amp; AopUtils.isHashCodeMethod(method)) &#123;</span><br><span class="line">				<span class="comment">// 直接调用当前类中的hashCode方法</span></span><br><span class="line">				<span class="keyword">return</span> hashCode();</span><br><span class="line">			&#125;</span><br><span class="line">             <span class="comment">// 方法来源于 DecoratingProxy 接口，这个接口中定义了一个方法用来获取原始的被代理的目标类，主要是用在嵌套代理的情况下（嵌套代理：代理对象又被作为目标对象进行了代理）</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (method.getDeclaringClass() == DecoratingProxy.class) &#123;</span><br><span class="line">				<span class="comment">// 内部通过循环遍历的方式，找到最原始的被代理的目标类</span></span><br><span class="line">				<span class="keyword">return</span> AopProxyUtils.ultimateTargetClass(<span class="keyword">this</span>.advised);</span><br><span class="line">			&#125;</span><br><span class="line">             <span class="comment">// 方法来源于Advised接口，代理对象默认情况下会实现Advised接口，可以通过代理对象来动态向代理对象中添加通知等</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.advised.opaque &amp;&amp; method.getDeclaringClass().isInterface() &amp;&amp;</span><br><span class="line">					method.getDeclaringClass().isAssignableFrom(Advised.class)) &#123;</span><br><span class="line">				<span class="comment">// this.advised是AdvisedSupport类型的，AdvisedSupport实现了Advised 接口中的所有方法</span></span><br><span class="line">				<span class="comment">// 所以最终通过反射方式交给this.advised来响应当前调用</span></span><br><span class="line">				<span class="keyword">return</span> AopUtils.invokeJoinpointUsingReflection(<span class="keyword">this</span>.advised, method, args);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 用来记录方法返回值</span></span><br><span class="line">			Object retVal;</span><br><span class="line"></span><br><span class="line">			<span class="comment">//是否需要在threadLocal中暴露代理对象</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.advised.exposeProxy) &#123;</span><br><span class="line">				<span class="comment">// 将代理对象暴露在上线文中，即暴露在threadLocal中，那么在当前线程中可以通过静态方法AopContext#currentProxy获取当前被暴露的代理对象</span></span><br><span class="line">				oldProxy = AopContext.setCurrentProxy(proxy);</span><br><span class="line">				setProxyContext = <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 通过目标源获取目标对象</span></span><br><span class="line">			target = targetSource.getTarget();</span><br><span class="line">             <span class="comment">// 获取目标对象类型</span></span><br><span class="line">			Class&lt;?&gt; targetClass = (target != <span class="keyword">null</span> ? target.getClass() : <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// @1：获取当前方法的拦截器链</span></span><br><span class="line">			List&lt;Object&gt; chain = <span class="keyword">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 拦截器链为空的情况下，表示这个方法上面没有找到任何增强的通知，那么会直接通过反射直接调用目标对象</span></span><br><span class="line">			<span class="keyword">if</span> (chain.isEmpty()) &#123;</span><br><span class="line">				<span class="comment">// 获取方法请求的参数（有时候方法中有可变参数(...)这种格式的参数，传入的参数类型和这种类型不一样的时候，会通过下面的adaptArgumentsIfNecessary方法进行转换）</span></span><br><span class="line">				Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);</span><br><span class="line">				<span class="comment">//通过反射直接调用目标方法</span></span><br><span class="line">				retVal = AopUtils.invokeJoinpointUsingReflection(target, method, argsToUse);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// 创建一个方法调用器（包含了代理对象、目标对象、调用的方法、参数、目标类型、 方法拦截器链）</span></span><br><span class="line">				MethodInvocation invocation =</span><br><span class="line">						<span class="keyword">new</span> ReflectiveMethodInvocation(proxy, target, method, args, targetClass, chain);</span><br><span class="line">				<span class="comment">// @3：通过拦截器链一个个调用最终到目标方法的调用</span></span><br><span class="line">				retVal = invocation.proceed();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 下面会根据方法返回值的类型，做一些处理，比如方法返回的类型为自己，则最后需要将返回值置为代理对象</span></span><br><span class="line">			Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line">			<span class="keyword">if</span> (retVal != <span class="keyword">null</span> &amp;&amp; retVal == target &amp;&amp;</span><br><span class="line">					returnType != Object.class &amp;&amp; returnType.isInstance(proxy) &amp;&amp;</span><br><span class="line">					!RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass())) &#123;</span><br><span class="line">				<span class="comment">// 将返回值设置为代理对象</span></span><br><span class="line">				retVal = proxy;</span><br><span class="line">			&#125;</span><br><span class="line">             <span class="comment">//retVal为null &amp;&amp; 不为void &amp;&amp; 方法的返回值类型returnType为八大基本类型</span></span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (retVal == <span class="keyword">null</span> &amp;&amp; returnType != Void.TYPE &amp;&amp; returnType.isPrimitive()) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> AopInvocationException(</span><br><span class="line">						<span class="string">&quot;Null return value from advice does not match primitive return type for: &quot;</span> + method);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> retVal;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="comment">// 目标对象不为null &amp;&amp; 目标源不是静态的或者说不是单例的</span></span><br><span class="line">			<span class="keyword">if</span> (target != <span class="keyword">null</span> &amp;&amp; !targetSource.isStatic()) &#123;</span><br><span class="line">				<span class="comment">// 必须释放来自TargetSource中的目标对象</span></span><br><span class="line">				targetSource.releaseTarget(target);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (setProxyContext) &#123;</span><br><span class="line">				<span class="comment">// 需要将旧的代理再放回到上线文中</span></span><br><span class="line">				AopContext.setCurrentProxy(oldProxy);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>小结</strong></p>
<ol>
<li>
<p>被创建的代理对象默认会实现 SpringProxy,Advised,DecoratingProxy 3个接口</p>
</li>
<li>
<p>SpringProxy 这个接口中没有任何方法，只是起一个标记作用，用来标记代理对象是使用spring aop创建的</p>
</li>
<li>
<p>代理对象默认都会实现 Advised 接口，所以可以通过这个接口动态变更代理对象中的通知</p>
</li>
<li>
<p>DecoratingProxy 接口中定义了一个方法 getDecoratedClass ，用来获取被代理的原始目标对象的类型</p>
</li>
</ol>
<h4 id="CglibAopProxy%E7%B1%BB"><a class="header-anchor" href="#CglibAopProxy%E7%B1%BB">¶</a> <strong>CglibAopProxy类</strong></h4>
<ul>
<li>getProxy</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 获取被代理的类</span></span><br><span class="line">        Class&lt;?&gt; rootClass = <span class="keyword">this</span>.advised.getTargetClass();</span><br><span class="line">        Assert.state(rootClass != <span class="keyword">null</span>, <span class="string">&quot;Target class must be available for creating a CGLIB proxy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 代理对象的父类（cglib是采用继承的方式来创建代理对象的，所以将被代理的类作为代理对象的父类）</span></span><br><span class="line">        Class&lt;?&gt; proxySuperClass = rootClass;</span><br><span class="line">        <span class="comment">// 判断被代理的类是不是cglib创建的类，如果是cblib创建的类，会将其父类作为被代理的类</span></span><br><span class="line">        <span class="keyword">if</span> (rootClass.getName().contains(ClassUtils.CGLIB_CLASS_SEPARATOR)) &#123;</span><br><span class="line">            proxySuperClass = rootClass.getSuperclass();</span><br><span class="line">            <span class="comment">//添加需要被代理的接口</span></span><br><span class="line">            Class&lt;?&gt;[] additionalInterfaces = rootClass.getInterfaces();</span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; additionalInterface : additionalInterfaces) &#123;</span><br><span class="line">                <span class="keyword">this</span>.advised.addInterface(additionalInterface);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Validate the class, writing log messages as necessary.</span></span><br><span class="line">        validateClassIfNecessary(proxySuperClass, classLoader);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开始cglib创建代理</span></span><br><span class="line">        Enhancer enhancer = createEnhancer();</span><br><span class="line">        <span class="keyword">if</span> (classLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">            enhancer.setClassLoader(classLoader);</span><br><span class="line">            <span class="keyword">if</span> (classLoader <span class="keyword">instanceof</span> SmartClassLoader &amp;&amp;</span><br><span class="line">                ((SmartClassLoader) classLoader).isClassReloadable(proxySuperClass)) &#123;</span><br><span class="line">                enhancer.setUseCache(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        enhancer.setSuperclass(proxySuperClass);</span><br><span class="line">        <span class="comment">// 设置被代理的接口[开发者硬编码指定的需要被代理的接口列表,SpringProxy,Advised]，这个比jdk动态代理的方式少了一个DecoratingProxy接口</span></span><br><span class="line">        enhancer.setInterfaces(AopProxyUtils.completeProxiedInterfaces(<span class="keyword">this</span>.advised));</span><br><span class="line">        <span class="comment">// 设置代理类类名生成策略（被代理class name + &quot;$$&quot; + 使用cglib处理的class name + &quot;BySpringCGLIB&quot; + &quot;$$&quot; + key的 hashcode）</span></span><br><span class="line">        enhancer.setNamingPolicy(SpringNamingPolicy.INSTANCE);</span><br><span class="line">        <span class="comment">// 设置字节码的生成策略</span></span><br><span class="line">        enhancer.setStrategy(<span class="keyword">new</span> ClassLoaderAwareGeneratorStrategy(classLoader));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// @1：获取Callback列表，</span></span><br><span class="line">        Callback[] callbacks = getCallbacks(rootClass);</span><br><span class="line">        Class&lt;?&gt;[] types = <span class="keyword">new</span> Class&lt;?&gt;[callbacks.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; types.length; x++) &#123;</span><br><span class="line">            types[x] = callbacks[x].getClass();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// @2：设置CallbackFilter，其内部会判断被代理对象中的方法最终会被callbacks列表中的那个Callback来处理</span></span><br><span class="line">        enhancer.setCallbackFilter(<span class="keyword">new</span> ProxyCallbackFilter(</span><br><span class="line">            <span class="keyword">this</span>.advised.getConfigurationOnlyCopy(), <span class="keyword">this</span>.fixedInterceptorMap, <span class="keyword">this</span>.fixedInterceptorOffset));</span><br><span class="line">        enhancer.setCallbackTypes(types);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取代理对象（内部会先创建代理类，然后会根据代理类生成一个代理对象）</span></span><br><span class="line">        <span class="keyword">return</span> createProxyClassAndInstance(enhancer, callbacks);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (CodeGenerationException | IllegalArgumentException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">&quot;Could not generate CGLIB subclass of &quot;</span> + <span class="keyword">this</span>.advised.getTargetClass() +</span><br><span class="line">                                     <span class="string">&quot;: Common causes of this problem include using a final class or a non-visible class&quot;</span>,</span><br><span class="line">                                     ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="comment">// TargetSource.getTarget() failed</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(<span class="string">&quot;Unexpected AOP exception&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>getCallbacks</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Callback[] getCallbacks(Class&lt;?&gt; rootClass) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 是否需要将代理暴露在threadLocal中</span></span><br><span class="line">    <span class="keyword">boolean</span> exposeProxy = <span class="keyword">this</span>.advised.isExposeProxy();</span><br><span class="line">    <span class="comment">// 配置是否是冻结的</span></span><br><span class="line">    <span class="keyword">boolean</span> isFrozen = <span class="keyword">this</span>.advised.isFrozen();</span><br><span class="line">    <span class="comment">// 被代理的目标对象是否是静态的（是否是单例的）</span></span><br><span class="line">    <span class="keyword">boolean</span> isStatic = <span class="keyword">this</span>.advised.getTargetSource().isStatic();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @1当方法上有需要执行的拦截器的时候，会用这个来处理</span></span><br><span class="line">    Callback aopInterceptor = <span class="keyword">new</span> DynamicAdvisedInterceptor(<span class="keyword">this</span>.advised);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当方法上没有需要执行的拦截器的时候，会使用targetInterceptor来处理，内部会通过反射直接 调用目标对象的方法</span></span><br><span class="line">    Callback targetInterceptor;</span><br><span class="line">    <span class="comment">// 根据是否要存储到threadLocal或是否要释放资源来创建不同的类</span></span><br><span class="line">    <span class="keyword">if</span> (exposeProxy) &#123;</span><br><span class="line">        targetInterceptor = (isStatic ?</span><br><span class="line">                             <span class="keyword">new</span> StaticUnadvisedExposedInterceptor(<span class="keyword">this</span>.advised.getTargetSource().getTarget()) :</span><br><span class="line">                             <span class="keyword">new</span> DynamicUnadvisedExposedInterceptor(<span class="keyword">this</span>.advised.getTargetSource()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        targetInterceptor = (isStatic ?</span><br><span class="line">                             <span class="keyword">new</span> StaticUnadvisedInterceptor(<span class="keyword">this</span>.advised.getTargetSource().getTarget()) :</span><br><span class="line">                             <span class="keyword">new</span> DynamicUnadvisedInterceptor(<span class="keyword">this</span>.advised.getTargetSource()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// targetDispatcher会直接调用目标方法</span></span><br><span class="line">    Callback targetDispatcher = (isStatic ?</span><br><span class="line">                                 <span class="keyword">new</span> StaticDispatcher(<span class="keyword">this</span>.advised.getTargetSource().getTarget()) : <span class="keyword">new</span> SerializableNoOp());</span><br><span class="line"></span><br><span class="line">    Callback[] mainCallbacks = <span class="keyword">new</span> Callback[] &#123;</span><br><span class="line">        aopInterceptor,  <span class="comment">// 处理匹配到拦截器的方法</span></span><br><span class="line">        targetInterceptor,  <span class="comment">// 处理未匹配到拦截器的方法</span></span><br><span class="line">        <span class="keyword">new</span> SerializableNoOp(),  <span class="comment">// no override for methods mapped to this</span></span><br><span class="line">        targetDispatcher, <span class="comment">// 处理未匹配到拦截器的方法，目标方法如果返回值的结果是目标对象类型的，会使用 targetInterceptor 处理，内部会返回代理对象</span></span><br><span class="line">        <span class="keyword">this</span>.advisedDispatcher, <span class="comment">// 处理Advised接口中定义的方法</span></span><br><span class="line">        <span class="keyword">new</span> EqualsInterceptor(<span class="keyword">this</span>.advised), <span class="comment">// 处理equals方法</span></span><br><span class="line">        <span class="keyword">new</span> HashCodeInterceptor(<span class="keyword">this</span>.advised) <span class="comment">// 处理hashCode方法</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    Callback[] callbacks;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果被代理的对象是单例的 &amp;&amp; 配置是冻结的，此时会进行优化，</span></span><br><span class="line">    <span class="comment">// 配置冻结的情况下，生成好的代理中通知是无法修改的，所以可以提前将每个方法对应的拦截器链找到给缓存起来</span></span><br><span class="line">    <span class="comment">// 调用方法的时候，就直接从缓存中可以拿到方法对应的缓存信息，效率会高一些</span></span><br><span class="line">    <span class="keyword">if</span> (isStatic &amp;&amp; isFrozen) &#123;</span><br><span class="line">        Method[] methods = rootClass.getMethods();</span><br><span class="line">        Callback[] fixedCallbacks = <span class="keyword">new</span> Callback[methods.length];</span><br><span class="line">        <span class="keyword">this</span>.fixedInterceptorMap = <span class="keyword">new</span> HashMap&lt;&gt;(methods.length);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取每个方法的调用链，然后给缓存在fixedInterceptorMap中</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; methods.length; x++) &#123;</span><br><span class="line">            Method method = methods[x];</span><br><span class="line">            List&lt;Object&gt; chain = <span class="keyword">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, rootClass);</span><br><span class="line">            fixedCallbacks[x] = <span class="keyword">new</span> FixedChainStaticTargetInterceptor(</span><br><span class="line">                chain, <span class="keyword">this</span>.advised.getTargetSource().getTarget(), <span class="keyword">this</span>.advised.getTargetClass());</span><br><span class="line">            <span class="keyword">this</span>.fixedInterceptorMap.put(method, x);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now copy both the callbacks from mainCallbacks</span></span><br><span class="line">        <span class="comment">// and fixedCallbacks into the callbacks array.</span></span><br><span class="line">        callbacks = <span class="keyword">new</span> Callback[mainCallbacks.length + fixedCallbacks.length];</span><br><span class="line">        System.arraycopy(mainCallbacks, <span class="number">0</span>, callbacks, <span class="number">0</span>, mainCallbacks.length);</span><br><span class="line">        System.arraycopy(fixedCallbacks, <span class="number">0</span>, callbacks, mainCallbacks.length, fixedCallbacks.length);</span><br><span class="line">        <span class="keyword">this</span>.fixedInterceptorOffset = mainCallbacks.length;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        callbacks = mainCallbacks;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> callbacks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>DynamicAdvisedInterceptor类</strong>：处理拦截器类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicAdvisedInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="comment">//代理配置信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdvisedSupport advised;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DynamicAdvisedInterceptor</span><span class="params">(AdvisedSupport advised)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.advised = advised;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用来处理代理对象中方法的调用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object proxy, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Object oldProxy = <span class="keyword">null</span>; <span class="comment">//被暴露在threadLocal中旧的代理对象</span></span><br><span class="line">        <span class="keyword">boolean</span> setProxyContext = <span class="keyword">false</span>; <span class="comment">//用来标记代理对象是否被暴露在threadLocal中</span></span><br><span class="line">        Object target = <span class="keyword">null</span>; <span class="comment">//目标对象</span></span><br><span class="line">        TargetSource targetSource = <span class="keyword">this</span>.advised.getTargetSource(); <span class="comment">//目标源</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//代理配置中是否需要将代理暴露在threadLocal中</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.advised.exposeProxy) &#123;</span><br><span class="line">                oldProxy = AopContext.setCurrentProxy(proxy);</span><br><span class="line">                setProxyContext = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//获取目标对象（即被代理的对象）</span></span><br><span class="line">            target = targetSource.getTarget();</span><br><span class="line">            Class&lt;?&gt; targetClass = (target != <span class="keyword">null</span> ? target.getClass() : <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//@1：获取当前方法的拦截器链</span></span><br><span class="line">            List&lt;Object&gt; chain = <span class="keyword">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line">            Object retVal; <span class="comment">//记录方法返回值</span></span><br><span class="line">            <span class="comment">//拦截器链为空 &amp;&amp; 方法是public类型的</span></span><br><span class="line">            <span class="keyword">if</span> (chain.isEmpty() &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">                <span class="comment">// 获取方法请求的参数（有时候方法中有可变参数(...)这种格式的参数，传入的参数类型和这种类型不一样的时候，会通过下面的adaptArgumentsIfNecessary方法进行转换）</span></span><br><span class="line">                Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);</span><br><span class="line">                <span class="comment">// 直接调用目标对象的方法</span></span><br><span class="line">                retVal = methodProxy.invoke(target, argsToUse);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 创建一个方法调用器（包含了代理对象、目标对象、调用的方法、参数、目标类型、 方法拦截器链） </span></span><br><span class="line">                <span class="comment">// @2：并执行方法调用器的processd()方法，此方法会一次执行方法调用链，最终会调用目标方法，获取返回结果</span></span><br><span class="line">                retVal = <span class="keyword">new</span> CglibMethodInvocation(proxy, target, method, args, targetClass, chain, methodProxy).proceed();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 处理方法返回结果：会根据方法返回值的类型，做一些处理，比如方法返回的类型为自己，则最后需要将返回值置为代理对象</span></span><br><span class="line">            retVal = processReturnType(proxy, target, method, retVal);</span><br><span class="line">            <span class="keyword">return</span> retVal;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 目标对象不为null &amp;&amp; 目标源不是静态的或者说不是单例的</span></span><br><span class="line">            <span class="keyword">if</span> (target != <span class="keyword">null</span> &amp;&amp; !targetSource.isStatic()) &#123;</span><br><span class="line">                <span class="comment">// 必须释放来自TargetSource中的目标对象</span></span><br><span class="line">                targetSource.releaseTarget(target);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (setProxyContext) &#123;</span><br><span class="line">                <span class="comment">// Restore old proxy.</span></span><br><span class="line">                AopContext.setCurrentProxy(oldProxy);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="%E6%96%B9%E6%B3%95%E6%8B%A6%E6%88%AA%E5%99%A8%E9%93%BE%E7%9A%84%E8%8E%B7%E5%8F%96"><a class="header-anchor" href="#%E6%96%B9%E6%B3%95%E6%8B%A6%E6%88%AA%E5%99%A8%E9%93%BE%E7%9A%84%E8%8E%B7%E5%8F%96">¶</a> <strong>方法拦截器链的获取</strong></h4>
<p><img src="/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220707230535133.png" alt="image-20220707230535133"></p>
<h2 id="%E4%BB%A3%E7%90%86%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%EF%BC%88%E6%8B%A6%E6%88%AA%E5%99%A8%E9%93%BE%E7%9A%84%E6%89%A7%E8%A1%8C%EF%BC%89"><a class="header-anchor" href="#%E4%BB%A3%E7%90%86%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%EF%BC%88%E6%8B%A6%E6%88%AA%E5%99%A8%E9%93%BE%E7%9A%84%E6%89%A7%E8%A1%8C%EF%BC%89">¶</a> 代理方法的调用过程（拦截器链的执行）</h2>
<p>创建完代理对象后，开始使用，在代理对象上执行一些方法调用，此时会依次调用此方法上的所有MethodInterceptor，最终会调用到目标上对应的方法。</p>
<p><img src="/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220707010100510.png" alt="image-20220707010100510"></p>
<ul>
<li>
<p>jdk动态代理：ReflectiveMethodInvocation#proceed</p>
</li>
<li>
<p>cglib代理：CglibAopProxy.CglibMethodInvocation#proceed</p>
</li>
</ul>
<p><strong>ReflectiveMethodInvocation类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectiveMethodInvocation</span> <span class="keyword">implements</span> <span class="title">ProxyMethodInvocation</span>, <span class="title">Cloneable</span> </span>&#123;</span><br><span class="line">	<span class="comment">//生成的代理对象 </span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Object proxy; </span><br><span class="line">    <span class="comment">//被代理的目标对象</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Object target; </span><br><span class="line">    <span class="comment">//被调用的方法</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Method method; </span><br><span class="line">    <span class="comment">//调用方法传入参数 </span></span><br><span class="line">    <span class="keyword">protected</span> Object[] arguments; </span><br><span class="line">    <span class="comment">//目标对象类型 </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; targetClass;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//当期被调用的方法上匹配的 MethodInterceptor and InterceptorAndDynamicMethodMatcher 列表，即方法调用链列表</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> List&lt;?&gt; interceptorsAndDynamicMethodMatchers;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//当前正在调用的连接器索引</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> currentInterceptorIndex = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="title">ReflectiveMethodInvocation</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">			Object proxy, <span class="meta">@Nullable</span> Object target, Method method, <span class="meta">@Nullable</span> Object[] arguments,</span></span></span><br><span class="line"><span class="function"><span class="params">			<span class="meta">@Nullable</span> Class&lt;?&gt; targetClass, List&lt;Object&gt; interceptorsAndDynamicMethodMatchers)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>.proxy = proxy;</span><br><span class="line">		<span class="keyword">this</span>.target = target;</span><br><span class="line">		<span class="keyword">this</span>.targetClass = targetClass;</span><br><span class="line">		<span class="keyword">this</span>.method = BridgeMethodResolver.findBridgedMethod(method);</span><br><span class="line">		<span class="keyword">this</span>.arguments = AopProxyUtils.adaptArgumentsIfNecessary(method, arguments);</span><br><span class="line">		<span class="keyword">this</span>.interceptorsAndDynamicMethodMatchers = interceptorsAndDynamicMethodMatchers;</span><br><span class="line">	&#125;	</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 处理被调用的方法，会递归进行调用，所有的拦截器都执行完毕之后，会通过反射调用目标方法</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		<span class="comment">// 拦截器都执行完毕之后，通过反射调用目标对象中的方法</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.currentInterceptorIndex == <span class="keyword">this</span>.interceptorsAndDynamicMethodMatchers.size() - <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> invokeJoinpoint();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">//获取++this.currentInterceptorIndex指定的拦截器</span></span><br><span class="line">		Object interceptorOrInterceptionAdvice =</span><br><span class="line">				<span class="keyword">this</span>.interceptorsAndDynamicMethodMatchers.get(++<span class="keyword">this</span>.currentInterceptorIndex);</span><br><span class="line">		<span class="keyword">if</span> (interceptorOrInterceptionAdvice <span class="keyword">instanceof</span> InterceptorAndDynamicMethodMatcher) &#123;</span><br><span class="line">			<span class="comment">//判断拦截器是否是InterceptorAndDynamicMethodMatcher，这种表示是动态拦截器</span></span><br><span class="line">			<span class="comment">// 所谓动态拦截器就是要根据方法的参数的值来判断拦截器是否需要执行</span></span><br><span class="line">			InterceptorAndDynamicMethodMatcher dm =</span><br><span class="line">					(InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;</span><br><span class="line">			Class&lt;?&gt; targetClass = (<span class="keyword">this</span>.targetClass != <span class="keyword">null</span> ? <span class="keyword">this</span>.targetClass : <span class="keyword">this</span>.method.getDeclaringClass());</span><br><span class="line">             <span class="comment">//判断动态拦截器是否需要执行</span></span><br><span class="line">			<span class="keyword">if</span> (dm.methodMatcher.matches(<span class="keyword">this</span>.method, targetClass, <span class="keyword">this</span>.arguments)) &#123;</span><br><span class="line">				<span class="comment">//执行当前拦截器的调用</span></span><br><span class="line">				<span class="keyword">return</span> dm.interceptor.invoke(<span class="keyword">this</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">//如果不匹配，直接递归进入下一个拦截器的调用</span></span><br><span class="line">				<span class="keyword">return</span> proceed();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">//执行拦截器的调用</span></span><br><span class="line">			<span class="keyword">return</span> ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(<span class="keyword">this</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//通过反射调用目标方法</span></span><br><span class="line">	<span class="meta">@Nullable</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Object <span class="title">invokeJoinpoint</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> AopUtils.invokeJoinpointUsingReflection(<span class="keyword">this</span>.target, <span class="keyword">this</span>.method, <span class="keyword">this</span>.arguments);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="%E5%88%9B%E5%BB%BAAOP%E4%BB%A3%E7%90%86"><a class="header-anchor" href="#%E5%88%9B%E5%BB%BAAOP%E4%BB%A3%E7%90%86">¶</a> 创建AOP代理</h2>
<p><img src="/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220708212633217.png" alt="image-20220708212633217"></p>
<h3 id="ProxyFactoryBean%E5%88%9B%E5%BB%BA"><a class="header-anchor" href="#ProxyFactoryBean%E5%88%9B%E5%BB%BA">¶</a> ProxyFactoryBean创建</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainConfig1</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Service1 <span class="title">service1</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> Service1(); &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Advisor <span class="title">interceptor1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MethodBeforeAdvice advice = <span class="keyword">new</span> MethodBeforeAdvice() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Method method, Object[] args, Object target)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;准备调用&quot;</span>+method);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 批量注册时，增强器的类型需要包装成Advisor类型</span></span><br><span class="line">        DefaultPointcutAdvisor advisor = <span class="keyword">new</span> DefaultPointcutAdvisor();</span><br><span class="line">        advisor.setAdvice(advice);</span><br><span class="line">        <span class="keyword">return</span> advisor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MethodInterceptor <span class="title">interceptor2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MethodInterceptor methodInterceptor = <span class="keyword">new</span> MethodInterceptor() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                <span class="keyword">long</span> starTime = System.nanoTime();</span><br><span class="line">                Object result = invocation.proceed();</span><br><span class="line">                <span class="keyword">long</span> endTime = System.nanoTime();</span><br><span class="line">                System.out.println(invocation.getMethod() + <span class="string">&quot;,耗时(纳秒)：&quot;</span> + (endTime - starTime));</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> methodInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AfterReturningAdvice <span class="title">afterReturningAdvice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AfterReturningAdvice afterReturningAdvice = <span class="keyword">new</span> AfterReturningAdvice() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, Method method, Object[] args, <span class="meta">@Nullable</span> Object target)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                System.out.println(method + <span class="string">&quot;，执行完毕!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> afterReturningAdvice;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProxyFactoryBean <span class="title">service1Proxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ProxyFactoryBean proxyFactoryBean = <span class="keyword">new</span> ProxyFactoryBean();</span><br><span class="line">        proxyFactoryBean.setTargetName(<span class="string">&quot;service1&quot;</span>);</span><br><span class="line">        <span class="comment">// 批量注册时类型：org.springframework.aop.Advisor 或 org.aopalliance.intercept.Interceptor</span></span><br><span class="line">        proxyFactoryBean.setInterceptorNames(<span class="string">&quot;interceptor*&quot;</span>, <span class="string">&quot;afterReturningAdvice&quot;</span>); <span class="comment">// *匹配符</span></span><br><span class="line">        <span class="keyword">return</span> proxyFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ProxyFactoryBean类主要方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123; </span><br><span class="line">       <span class="comment">//初始化advisor(拦截器)链 </span></span><br><span class="line">       initializeAdvisorChain(); </span><br><span class="line">       <span class="comment">//是否是单例 </span></span><br><span class="line">       <span class="keyword">if</span> (isSingleton()) &#123; </span><br><span class="line">           <span class="comment">//创建单例代理对象 return getSingletonInstance(); </span></span><br><span class="line">       &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//创建多例代理对象 </span></span><br><span class="line">           <span class="keyword">return</span> newPrototypeInstance(); </span><br><span class="line">       &#125; </span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initializeAdvisorChain</span><span class="params">()</span> <span class="keyword">throws</span> AopConfigException, BeansException </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.advisorChainInitialized) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!ObjectUtils.isEmpty(<span class="keyword">this</span>.interceptorNames)) &#123;</span><br><span class="line">           <span class="comment">// 轮询 interceptorNames</span></span><br><span class="line">           <span class="keyword">for</span> (String name : <span class="keyword">this</span>.interceptorNames) &#123;</span><br><span class="line">               <span class="comment">//批量注册的方式：判断name是否以*结尾</span></span><br><span class="line">               <span class="keyword">if</span> (name.endsWith(GLOBAL_SUFFIX)) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (!(<span class="keyword">this</span>.beanFactory <span class="keyword">instanceof</span> ListableBeanFactory)) &#123;</span><br><span class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> AopConfigException(</span><br><span class="line">                           <span class="string">&quot;Can only use global advisors or interceptors with a ListableBeanFactory&quot;</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="comment">//@1：从容器中匹配查找匹配的增强器，将其添加到aop配置中</span></span><br><span class="line">                   addGlobalAdvisors((ListableBeanFactory) <span class="keyword">this</span>.beanFactory,</span><br><span class="line">                                     name.substring(<span class="number">0</span>, name.length() - GLOBAL_SUFFIX.length()));</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">//非匹配的方式：按照name查找bean</span></span><br><span class="line">                   Object advice;</span><br><span class="line">                   <span class="keyword">if</span> (<span class="keyword">this</span>.singleton || <span class="keyword">this</span>.beanFactory.isSingleton(name)) &#123;</span><br><span class="line">                       advice = <span class="keyword">this</span>.beanFactory.getBean(name);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">else</span> &#123;</span><br><span class="line">                       advice = <span class="keyword">new</span> PrototypePlaceholderAdvisor(name);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="comment">// 将advice包装为Advisor丢到aop配置中</span></span><br><span class="line">                   addAdvisorOnChainCreation(advice);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.advisorChainInitialized = <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="AspectJProxyFactory%E5%88%9B%E5%BB%BA"><a class="header-anchor" href="#AspectJProxyFactory%E5%88%9B%E5%BB%BA">¶</a> AspectJProxyFactory创建</h3>
<p><code>@Aspect</code> 标注的类上，这个类中，可以通过通过 <code>@Pointcut</code> 来定义切入点，可以通过 <code>@Before</code>、 <code>@Around</code>、<code>@After</code>、<code>@AfterRunning</code>、<code>@AfterThrowing</code> 标注在方法上来定义通知，定义好了之后，将<code>@Aspect</code>标注的这个类交给 <code>AspectJProxyFactory</code> 来解析生成 Advisor 链，进而结合目标对象一起来生成代理对象.</p>
<h3 id="%40Pointcut%E7%9A%8412%E7%A7%8D%E7%94%A8%E6%B3%95"><a class="header-anchor" href="#%40Pointcut%E7%9A%8412%E7%A7%8D%E7%94%A8%E6%B3%95">¶</a> @Pointcut的12种用法</h3>
<p><strong>表达式标签（10种）:</strong></p>
<ul>
<li>
<p>execution：用于匹配方法执行的连接点</p>
</li>
<li>
<p>within：用于匹配指定类型内的方法执行</p>
</li>
<li>
<p>this：用于匹配当前AOP代理对象类型的执行方法；注意是AOP代理对象的类型匹配，这样就可能包括引入接口也类型匹配</p>
</li>
<li>
<p>target：用于匹配当前目标对象类型的执行方法；注意是目标对象的类型匹配，这样就不包括引入接口也类型匹配</p>
</li>
<li>
<p>args：用于匹配当前执行的方法传入的参数为指定类型的执行方法</p>
</li>
<li>
<p>@within：用于匹配所有持有指定注解类型内的方法</p>
</li>
<li>
<p>@target：用于匹配当前目标对象类型的执行方法，其中目标对象持有指定的注解</p>
</li>
<li>
<p>@args：用于匹配当前执行的方法传入的<strong>参数所属的类</strong>持有指定注解的</p>
</li>
<li>
<p>@annotation：用于匹配当前执行方法持有指定注解的</p>
</li>
<li>
<p>bean：Spring AOP扩展的，AspectJ没有对于指示符，用于匹配特定名称的Bean对象的执行方法</p>
</li>
</ul>
<p><strong>execution格式</strong></p>
<p><code>execution(modifiers-pattern? ret-type-pattern declaring-type-pattern? name-pattern(param-pattern) throws-pattern?)</code></p>
<ul>
<li>带?号的为可选项</li>
<li>modifier-pattern? 修饰符匹配，如public 表示匹配公有方法</li>
<li>ret-type-pattern 返回值匹配，* 表示任何返回值，全路径的类名等</li>
<li>declaring-type-pattern? 类路径匹配，com.example…IService+代表com.example包及其子包下所有IService接口及子类型的</li>
<li>name-pattern 方法名匹配，* 代表所有，set*，代表以set开头的所有方法</li>
<li>(param-pattern) 参数匹配，(…)代表所有参数；(*,String)代表第一个参数为任何值,第二个为String类型；(…,String)代表最后一个参数是String类型</li>
<li>throws-pattern? 异常类型匹配</li>
</ul>
<table>
<thead>
<tr>
<th><strong>表达式标签</strong></th>
<th><strong>判断的对象</strong></th>
<th><strong>判断规则</strong>**(x****：指表达式中指定的类型****)**</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>within</strong></td>
<td>target对象</td>
<td>target.getClass().equals(表达式中指定的类型)</td>
</tr>
<tr>
<td><strong>this</strong></td>
<td>proxy对象</td>
<td>x.getClass().isAssignableFrom(proxy.getClass());</td>
</tr>
<tr>
<td><strong>target</strong></td>
<td>target对象</td>
<td>x.getClass().isAssignableFrom(target.getClass());</td>
</tr>
</tbody>
</table>
<p><img src="/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/image-20220708234953751.png" alt="image-20220708234953751"></p>
<h2 id="%40Aspect%E4%B8%AD5%E7%A7%8D%E9%80%9A%E7%9F%A5"><a class="header-anchor" href="#%40Aspect%E4%B8%AD5%E7%A7%8D%E9%80%9A%E7%9F%A5">¶</a> @Aspect中5种通知</h2>
<ol>
<li>
<p>@Before：前置通知, 在方法执行之前执行</p>
</li>
<li>
<p>@Aroud：环绕通知, 围绕着方法执行</p>
</li>
<li>
<p>@After：后置通知, 在方法执行之后执行</p>
</li>
<li>
<p>@AfterReturning：返回通知, 在方法返回结果之后执行</p>
</li>
<li>
<p>@AfterThrowing：异常通知, 在方法抛出异常之后</p>
</li>
</ol>
<p><img src="/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20220716155002.png" alt="微信图片_20220716155002"></p>
<p><strong>执行顺序</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReflectiveAspectJAdvisorFactory，v5.2.9.RELEASE</span></span><br><span class="line"><span class="comment">// 执行顺序：@Around、@Before、@After、@AfterReturning、@AfterThrowing</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Comparator&lt;Method&gt; METHOD_COMPARATOR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">// 通过instanceOrder数组索引位置来排序</span></span><br><span class="line">    Comparator&lt;Method&gt; adviceKindComparator = <span class="keyword">new</span> ConvertingComparator&lt;&gt;(</span><br><span class="line">        <span class="keyword">new</span> InstanceComparator&lt;&gt;(</span><br><span class="line">            Around.class, Before.class, After.class, AfterReturning.class, AfterThrowing.class),</span><br><span class="line">        (Converter&lt;Method, Annotation&gt;) method -&gt; &#123;</span><br><span class="line">            AspectJAnnotation&lt;?&gt; ann = AbstractAspectJAdvisorFactory.findAspectJAnnotationOnMethod(method);</span><br><span class="line">            <span class="keyword">return</span> (ann != <span class="keyword">null</span> ? ann.getAnnotation() : <span class="keyword">null</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    Comparator&lt;Method&gt; methodNameComparator = <span class="keyword">new</span> ConvertingComparator&lt;&gt;(Method::getName);</span><br><span class="line">    METHOD_COMPARATOR = adviceKindComparator.thenComparing(methodNameComparator);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在CglibAopProxy.CglibMethodInvocation#proceed中根据拦截器链依次执行拦截器</span></span><br><span class="line"><span class="comment">// 注意每次调用拦截器时都会使用到proceed中双catch的方式，下面只保留了最外面的</span></span><br><span class="line"><span class="comment">// 构造出的执行顺序大致如下：</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;@Around通知start&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;@Before通知!&quot;</span>);</span><br><span class="line">    Object retVal = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        	retVal = mi.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="comment">// 抛出的异常是给定抛出类型的子类型时</span></span><br><span class="line">            <span class="keyword">if</span> (shouldInvokeOnThrowing(ex)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;@AfterThrowing通知!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        	<span class="comment">//继续抛出异常</span></span><br><span class="line">        	<span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;@AfterReturning通知!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;@After通知!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;@Around通知end&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> retVal;</span><br><span class="line">&#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">    <span class="comment">// 抛出运行时异常</span></span><br><span class="line">    <span class="keyword">throw</span> ex;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ReflectionUtils.declaresException(getMethod(), ex.getClass())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 方法未声明该异常则抛出UndeclaredThrowableException异常</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<script>
    let imgs = document.getElementsByTagName('img');
    for (let img of imgs) {
        img.setAttribute('class', 'fancybox');
    }
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css">
      
        <div class="mdui-m-y-2 mdui-text-center">
          <button class="mdui-fab mdui-color-deep-orange mdui-text-color-white mdui-ripple" mdui-dialog="{target: '#donate'}" mdui-tooltip="{content: '打赏', position: 'top'}"><i class="mdui-icon material-icons">thumb_up</i></button>
        </div>
      
      <blockquote>
        
        <strong>本文链接：</strong><br><a href="http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/">http://lampkins.gitee.io/2022/02/10/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/</a>
      </blockquote>
    </div>
    <footer class="mdui-card-actions">
      
        <a class="mdui-ripple article_categories-link" href="/categories/Java/">Java</a>
      
      
        <a class="mdui-ripple article_tags-link" href="/tags/Spring/" rel="tag">Spring</a>
      
    </footer>
    
      <div class="mdui-dialog" id="donate">
        <div class="mdui-tab mdui-tab-centered">
          
            <a href="#donate-0" class="mdui-ripple">QQ支付</a>
          
            <a href="#donate-1" class="mdui-ripple">支付宝</a>
          
        </div>
        
        
          <div id="donate-0" class="mdui-p-a-2 mdui-typo mdui-text-center">
            
              <img src="/images/qqpay.jpg" style="width: 300px;">
            
          </div>
        
          <div id="donate-1" class="mdui-p-a-2 mdui-typo mdui-text-center">
            
              <img src="/images/alipay.jpg" style="width: 300px;">
            
          </div>
        
      </div>
    
  </article>
  
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>

  <script>$("#main article .mdui-card-content img.fancybox").on("click",function(e){$.fancybox.open({src:$(this).attr("src")});});</script>


  <nav id="paginator">
    
    <div class="spacer"></div>
    
      <a rel="next" class="extend next" href="/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">
        <span class="mdui-p-x-3" mdui-tooltip="{content: 'Spring上下文生命周期'}">下一篇</span>
        <button aria-label="next" class="mdui-btn mdui-btn-raised mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_forward</i></button>
      </a>
    
  </nav>


  <div id="comment" class="mdui-m-t-5 mdui-m-x-1">
    <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
  var gitalk = new Gitalk({
    clientID: 'd17f668bcd7f140d735f',
    clientSecret: '3058f2300347db4f27a87d10648565e8d0549033',
    repo: 'Lampkins.github.io',
    owner: 'lampkins',
    admin: ['lampkins'],
    id: 'b1b2fe1d-81b4-3ec3-dafb-f4e1287ad902' || location.pathname,
    distractionFreeMode: false
  });
  gitalk.render('gitalk-container');
</script>
  </div>



  <div style="position: fixed !important; right: 16px; top: 30%;">
    <button class="mdui-fab mdui-fab-mini mdui-ripple" mdui-menu="{target: '#toc'}"><i class="mdui-icon material-icons">toc</i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item" disabled><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Advice%E9%80%9A%E7%9F%A5%E7%9B%B8%E5%85%B3%E7%9A%84%E7%B1%BB"><span class="toc-text"> Advice通知相关的类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PointCut%E5%88%87%E5%85%A5%E7%82%B9%E7%9B%B8%E5%85%B3%E7%B1%BB"><span class="toc-text"> PointCut切入点相关类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Advisor%E9%A1%BE%E9%97%AE"><span class="toc-text"> Advisor顾问</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-text"> 代理创建过程源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1.%20%E5%88%9B%E5%BB%BA%E4%BB%A3%E7%90%86%E6%89%80%E9%9C%80%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE"><span class="toc-text"> 1. 创建代理所需参数配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2.%20%E6%A0%B9%E6%8D%AE%E9%85%8D%E7%BD%AE%E8%8E%B7%E5%8F%96AopProxy%E5%AF%B9%E8%B1%A1"><span class="toc-text"> 2. 根据配置获取AopProxy对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3.%20%E9%80%9A%E8%BF%87AopProxy%E5%88%9B%E5%BB%BA%E4%BB%A3%E7%90%86%E5%AF%B9%E8%B1%A1"><span class="toc-text"> 3. 通过AopProxy创建代理对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JdkDynamicAopProxy%E7%B1%BB"><span class="toc-text"> JdkDynamicAopProxy类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CglibAopProxy%E7%B1%BB"><span class="toc-text"> CglibAopProxy类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E6%8B%A6%E6%88%AA%E5%99%A8%E9%93%BE%E7%9A%84%E8%8E%B7%E5%8F%96"><span class="toc-text"> 方法拦截器链的获取</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%EF%BC%88%E6%8B%A6%E6%88%AA%E5%99%A8%E9%93%BE%E7%9A%84%E6%89%A7%E8%A1%8C%EF%BC%89"><span class="toc-text"> 代理方法的调用过程（拦截器链的执行）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAAOP%E4%BB%A3%E7%90%86"><span class="toc-text"> 创建AOP代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ProxyFactoryBean%E5%88%9B%E5%BB%BA"><span class="toc-text"> ProxyFactoryBean创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AspectJProxyFactory%E5%88%9B%E5%BB%BA"><span class="toc-text"> AspectJProxyFactory创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#@Pointcut%E7%9A%8412%E7%A7%8D%E7%94%A8%E6%B3%95"><span class="toc-text"> @Pointcut的12种用法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#@Aspect%E4%B8%AD5%E7%A7%8D%E9%80%9A%E7%9F%A5"><span class="toc-text"> @Aspect中5种通知</span></a></li></ol></li>
    </ul>
  </div>
</main>
  <footer id="footer" class="mdui-m-t-5 mdui-p-y-3 mdui-color-theme">
  <div class="mdui-p-y-0 mdui-text-center">
    
      <a href="https://github.com/Lampkins" target="_blank" class="mdui-btn mdui-btn-icon mdui-text-color-theme-a100"><i class="mdui-icon iconfont">&#xe7ab;</i></a>
    
    
      <a href="https://gitee.com/lampkins" target="_blank" class="mdui-btn mdui-btn-icon mdui-text-color-theme-a100"><i class="mdui-icon iconfont1">&#xe686;</i></a>
    
    
    
    
    
    
      <a href="https://www.instagram.com/arimis0" target="_blank" class="mdui-btn mdui-btn-icon mdui-text-color-theme-a100"><i class="mdui-icon iconfont1">&#xe736;</i></a>
    
    
    
    
    
    
      <a href="https://qm.qq.com/cgi-bin/qm/qr?k=g3rAKPWjqKBJ7oezteErpQGrtxISDNmp&noverify=0" target="_blank" class="mdui-btn mdui-btn-icon mdui-text-color-theme-a100"><i class="mdui-icon iconfont">&#xe651;</i></a>
    
    
  </div>
  <div class="mdui-p-y-1 mdui-text-center">
    Copyright &copy; 2019 - 2022 Lampkins<br>
    Powered by <a href="https://hexo.io/" target="_blank" class="mdui-text-color-theme-accent">Hexo</a> | Theme by <a href="https://github.com/niemingzhao/niemingzhao.github.io/tree/theme" target="_blank" class="mdui-text-color-theme-accent">default</a>
    <br>
      <span id="busuanzi_container_site_pv" style="display: none;"><i class="iconfont">&#xe7fd;</i> <span id="busuanzi_value_site_pv"></span></span> &nbsp;&nbsp;
      <span id="busuanzi_container_site_uv" style="display: none;"><i class="iconfont">&#xe601;</i> <span id="busuanzi_value_site_uv"></span></span>
    
  </div>
</footer>
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_upward</i></button>
  <script async src="http://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  
<script src="/js/mdui.js"></script>
<script src="/js/script.js"></script>

  
<script src="/custom.js"></script>

</body>
</html>