<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="renderer" content="webkit">

  
  <title>Spring上下文生命周期 | 博客</title>

  <link rel="shortcut icon" href="/images/favicon.png">
  <link rel="alternate" href="/atom.xml" title="博客" type="application/atom+xml">
  <meta name="description" content="¶ 1、什么是spring应用上下文？ 接口org.springframework.context.ApplicationContext表示spring上下文，下面2个实现类 12org.springframework.context.support.ClassPathXmlApplicationContextorg.springframework.context.annotation.Annot">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring上下文生命周期">
<meta property="og:url" content="http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/index.html">
<meta property="og:site_name" content="博客">
<meta property="og:description" content="¶ 1、什么是spring应用上下文？ 接口org.springframework.context.ApplicationContext表示spring上下文，下面2个实现类 12org.springframework.context.support.ClassPathXmlApplicationContextorg.springframework.context.annotation.Annot">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/image-20220723164333042.png">
<meta property="og:image" content="http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/640.png">
<meta property="og:image" content="http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/image-20220808173406936.png">
<meta property="og:image" content="http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/image-20220810234338026.png">
<meta property="article:published_time" content="2022-02-10T10:57:49.000Z">
<meta property="article:modified_time" content="2022-10-13T02:43:03.466Z">
<meta property="article:author" content="Lampkins">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/image-20220723164333042.png">

  <meta name="keywords" content=",Spring">
  <meta name="format-detection" content="telephone=no,email=no">
  <meta name="theme-color" content="#9C27B0">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="博客">
  <meta name="msapplication-starturl" content="http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">
  <meta name="msapplication-navbutton-color" content="#9C27B0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="博客">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/images/favicon.png">

  
    <link rel="canonical" href="http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">
  

  
  

  
  
  

  
<link rel="stylesheet" href="/css/mdui.css">
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/custom.css">

<meta name="generator" content="Hexo 5.2.0"></head>
<body class="mdui-appbar-with-toolbar mdui-theme-primary-blue-grey mdui-theme-accent-blue">
  <script>var a=localStorage.getItem("mdui-theme-layout-dark");if(a){document.getElementsByTagName("body")[0].className+=" mdui-theme-layout-dark"};</script>
  <script>var a=localStorage.getItem("mdui-drawer-close");if(!a){document.getElementsByTagName("body")[0].className+=" mdui-drawer-body-left"};</script>
  <header id="header" class="mdui-appbar mdui-appbar-fixed mdui-appbar-scroll-hide mdui-appbar-inset">
  <div class="mdui-toolbar mdui-color-theme">
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="mdui-icon material-icons">menu</i></a>
    <a href="/" class="mdui-typo-headline">博客</a>
    <div class="mdui-toolbar-spacer"></div>
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: '搜索'}"><i class="mdui-icon material-icons">search</i></a>
    <a href="/atom.xml" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: 'RSS'}"><i class="mdui-icon material-icons">rss_feed</i></a>
    <a id="mode" href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: 'D/N'}"><i class="mdui-icon material-icons">brightness_5</i></a>
  </div>
</header>
<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字">
    </div>
    <div class="search-result" data-resource="/search.xml"></div>
  
</div>
  <aside id="sidebar" class="mdui-drawer mdui-drawer-full-height mdui-shadow-3">
  <script>var a=localStorage.getItem("mdui-drawer-close");if(a){document.getElementById("sidebar").className+=" mdui-drawer-close"};</script>
  <div class="mdui-grid-tile">
    <img src="/images/banner1.jpg" style="height: auto;">
    <img src="/images/avatar1.jpg" class="avatar-animation" style="position: absolute; top: 10%; left: 24px; width: 64px; height: 64px; border: 2px solid #fff; border-radius: 50%;">
    <div class="mdui-grid-tile-actions">
      <div class="mdui-grid-tile-text">
        <div class="mdui-grid-tile-title">Lampkins</div>
        <div class="mdui-grid-tile-subtitle"><i class="mdui-icon material-icons">art_track</i>Creator by ❤️</div>
      </div>
      
        <div class="mdui-grid-tile-buttons">
          <a href="mailto:arivins_lau@foxmail.com" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: 'arivins_lau@foxmail.com'}"><i class="mdui-icon material-icons">email</i></a>
        </div>
      
    </div>
  </div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    <a href="/" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-blue">home</i>
      <div class="mdui-list-item-content">主页</div>
    </a>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-deep-orange">archive</i>
        <div class="mdui-list-item-content">归档</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/archives/2022/02/">二月 2022<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/08/">八月 2021<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/11/">十一月 2020<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/10/">十月 2020<span class="mdui-ripple sidebar_archives-count">10</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/09/">九月 2020<span class="mdui-ripple sidebar_archives-count">4</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-green">class</i>
        <div class="mdui-list-item-content">分类</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/categories/Java/">Java<span class="mdui-ripple sidebar_archives-count">6</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/%E6%8A%80%E6%9C%AF/">技术<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库<span class="mdui-ripple sidebar_archives-count">10</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">MySQL性能优化<span class="mdui-ripple sidebar_archives-count">8</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/%E6%B5%8B%E8%AF%95/">测试<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/%E9%98%BF%E9%87%8C%E4%BA%91/">阿里云<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-brown">bookmark</i>
        <div class="mdui-list-item-content">标签</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/tags/ACID/" rel="tag">ACID<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/B-%E6%A0%91/" rel="tag">B+树<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/B%E6%A0%91/" rel="tag">B树<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/JMM/" rel="tag">JMM<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/JVM/" rel="tag">JVM<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/Java/" rel="tag">Java<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/Java%E9%94%81/" rel="tag">Java锁<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/MySQL/" rel="tag">MySQL<span class="mdui-ripple sidebar_archives-count">8</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/Redis/" rel="tag">Redis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/Spring/" rel="tag">Spring<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/SpringMVC/" rel="tag">SpringMVC<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/markdown/" rel="tag">markdown<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/%E4%BA%8B%E5%8A%A1/" rel="tag">事务<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/%E4%BC%98%E5%8C%96/" rel="tag">优化<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/%E6%97%A5%E5%BF%97%E9%87%87%E9%9B%86/" rel="tag">日志采集<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/%E7%B4%A2%E5%BC%95/" rel="tag">索引<span class="mdui-ripple sidebar_archives-count">8</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <a href="/about" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-purple">person</i>
      <div class="mdui-list-item-content">关于</div>
    </a>
  </div>

  <div class="mdui-divider"></div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    
      <a href="/timeline" class="mdui-list-item mdui-ripple">时间轴</a>
    
      <a href="/tagcloud" class="mdui-list-item mdui-ripple">标签云</a>
    
      <a href="/gallery" class="mdui-list-item mdui-ripple">画　廊</a>
    
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <div class="mdui-list-item-content">友情链接</div>
        <i class="mdui-list-item-icon mdui-icon material-icons">link</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
          <a href="/pdf/简历.pdf" target="_blank" class="mdui-list-item mdui-p-l-2 mdui-text-color-theme-accent mdui-ripple" style="justify-content: center;">个人简历</a>
        
          <a href="https://imgchr.com/3312862586" target="_blank" class="mdui-list-item mdui-p-l-2 mdui-text-color-theme-accent mdui-ripple" style="justify-content: center;">路过图床</a>
        
          <a href="https://github.com/Lampkins/Lampkins.github.io" target="_blank" class="mdui-list-item mdui-p-l-2 mdui-text-color-theme-accent mdui-ripple" style="justify-content: center;">博客托管</a>
        
        
      </div>
    </div>
  </div>
</aside>
  <main id="main" class="mdui-m-t-5 fadeIn animated">
  
<link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css">

  <style>#main article .mdui-card-content .center-block{display:block!important;margin-right:auto!important;margin-left:auto!important}</style>
  <article class="mdui-card mdui-m-b-5" style="margin-top: -40px !important;">
    <header class="mdui-card-media">
      <img src="/images/random/material-7.png" style="max-height: 240px;">
      <div class="mdui-card-media-covered">
        <div class="mdui-card-primary">
          <div class="mdui-card-primary-title">Spring上下文生命周期</div>
          <div class="mdui-card-primary-subtitle">
            
            <i class="iconfont">&#xe697;</i> 2022-02-10 / <i class="iconfont">&#xe601;</i> Lampkins &nbsp;&nbsp; <span id="busuanzi_container_page_pv" style="display: none;"><i class="iconfont">&#xe7fd;</i> <span id="busuanzi_value_page_pv"></span></span>
          </div>
        </div>
      </div>
      <div class="mdui-card-menu">
        
          <button class="mdui-btn mdui-btn-icon mdui-text-color-white" mdui-menu="{target: '#qrcode', align: 'right'}"><i class="mdui-icon material-icons">devices</i></button>
          <ul class="mdui-menu" id="qrcode">
            
              <li class="mdui-menu-item"><a class="mdui-text-center mdui-ripple">发送到手机</a></li>
            
            <li class="mdui-menu-item" disabled>
              
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQ4AAAEOCAAAAABd2qZ5AAADgklEQVR42u3aQW4jMQwEwPz/07vXAAs73aQ08QI1p8AYyFLlQJPqrz+eb88XAhw4cODAgQMHDhw4PpjjK36+v5+v8O877Scvj1Hu5N/1ceDAgQPHPY4fStHbTedbfPX+++2+ejP59miHOHDgwIHjGkdeXHOIhCYvivk+ix8KOHDgwIHjVzmSIyVvzop6Xmhx4MCBA8f/wrEpkMVVUPngwIEDB47P5Ji1Z+83scGaXTs9OivFgQMHDhxHAw2f+fev5Ttw4MCBA8e6udpcON17pz4RDhw4cOA4ypFf8+Qb3Ufr8sI5Ww0HDhw4cDzJ0V41tSV5FpvYt5c4cODAgeMZjjxMkKPM4nH5mnkhj74dBw4cOHAc5cgL0mxQ+P79TYSiDUysOlocOHDgwBFzJM3bfoA4i03Myme9Dg4cOHDguMyxGR3mQ8B2hQ3TD/9sHDhw4MBxgWN2XRTFBQ41WvkYsW0yceDAgQPH8xx5I9f+fapw5mG+1S0cDhw4cOAoOWYjv32UYVZEk+YzCv/hwIEDB47LHMmBZ+1TfrA2rteujwMHDhw47nEkY75ZQT3LOms460KLAwcOHDgO9Sx589YGoDfxhba1GwYgcODAgQPHBY786/dXR/n6mx8EyeUZDhw4cOC4wTGLKbThg7Z4zxDbT3DgwIEDxw2O/MJmM6TLi+imIZyNIHHgwIEDxzMcbejt2OYCmqI9S34c4MCBAweOCxx58zPbbl4g921ke2WFAwcOHDhucJyKDrQhidkF1QwXBw4cOHA8z3FqLHg2lDArycUnOHDgwIHjGkd+7FkRTdbZ7OfwrBQHDhw4cIw49l85G8+dCsbl0Yco0IADBw4cONYc+dVOPoxruTdtXt6w4cCBAweOZziSQNs+DN2OHWcFfrhbHDhw4MBxlCMZ27WH3Ldk+wMXQT0cOHDgwHGBI2nDNkHqvD3bE7cBOxw4cODAcYOjvUaaFbm8hOeXW5tRJg4cOHDguMHRFqd8aNheAs1Y8wD3S1AcOHDgwHGBYzbymwUR8gunpEVs18GBAwcOHE9yJAUs+aRdpx0sbkaEOHDgwIHj0zjay6dZKGF2sGPDQRw4cODA8ascs7jDLL6wv3DCgQMHDhxPcrQhhtmlUTvCa9u5mg8HDhw4cFzgaAMN77feNmn7YjyLUODAgQMHjhscHhw4cODAgQMHDhw4cHzY8xf+gW2+6VLEYQAAAABJRU5ErkJggg==">
              
            </li>
          </ul>
        
        
          <button class="mdui-btn mdui-btn-icon mdui-text-color-white" mdui-menu="{target: '#share_menu', align: 'right'}"><i class="mdui-icon material-icons">share</i></button>
          <ul class="mdui-menu" id="share_menu">
            <li class="mdui-menu-item">
              <a href="http://service.weibo.com/share/share.php?appkey=&title=Spring上下文生命周期&url=http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/&pic=http://lampkins.gitee.io/images/favicon.png&searchPic=false&style=simple" target="_blank" class="mdui-ripple">分享到 Weibo</a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://twitter.com/intent/tweet?text=Spring上下文生命周期&url=http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/&via=Lampkins" target="_blank" class="mdui-ripple">分享到 Twitter</a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://www.facebook.com/sharer/sharer.php?u=http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" target="_blank" class="mdui-ripple">分享到 Facebook</a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://plus.google.com/share?url=http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" target="_blank" class="mdui-ripple">分享到 Google+</a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/&title=Spring上下文生命周期" target="_blank" class="mdui-ripple">分享到 LinkedIn</a>
            </li>
            <li class="mdui-menu-item">
              <a href="http://connect.qq.com/widget/shareqq/index.html?site=博客&title=Spring上下文生命周期&pics=http://lampkins.gitee.io/images/favicon.png&url=http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" target="_blank" class="mdui-ripple">分享到 QQ</a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://telegram.me/share/url?url=http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/&text=Spring上下文生命周期" target="_blank" class="mdui-ripple">分享到 Telegram</a>
            </li>
          </ul>
        
      </div>
    </header>
    <div class="mdui-card-content mdui-typo">
      <h2 id="1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFspring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%9F"><a class="header-anchor" href="#1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFspring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%9F">¶</a> 1、什么是spring应用上下文？</h2>
<p>接口<code>org.springframework.context.ApplicationContext</code>表示spring上下文，下面2个实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.support.ClassPathXmlApplicationContext</span><br><span class="line">org.springframework.context.annotation.AnnotationConfigApplicationContext</span><br></pre></td></tr></table></figure>
<h2 id="2%E3%80%81%E5%BA%94%E7%94%A8%E4%B8%8A%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F(14%E4%B8%AA%E9%98%B6%E6%AE%B5)"><a class="header-anchor" href="#2%E3%80%81%E5%BA%94%E7%94%A8%E4%B8%8A%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F(14%E4%B8%AA%E9%98%B6%E6%AE%B5)">¶</a> 2、应用上文生命周期(14个阶段)</h2>
<p>1、创建spring应用上下文</p>
<p>2、上下文启动准备阶段</p>
<p>3、BeanFactory创建阶段</p>
<p>4、BeanFactory准备阶段</p>
<p>5、BeanFactory后置处理阶段</p>
<p>6、BeanFactory注册BeanPostProcessor阶段</p>
<p>7、初始化内建Bean：MessageSource</p>
<p>8、初始化内建Bean：Spring事件广播器</p>
<p>9、Spring应用上下文刷新阶段</p>
<p>10、Spring事件监听器注册阶段</p>
<p>11、单例bean实例化阶段</p>
<p>12、BeanFactory初始化完成阶段</p>
<p>13、Spring应用上下文启动完成阶段</p>
<p>14、Spring应用上下文关闭阶段</p>
<h2 id="3%E3%80%81Spring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E4%BD%BF%E7%94%A8"><a class="header-anchor" href="#3%E3%80%81Spring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E4%BD%BF%E7%94%A8">¶</a> 3、Spring应用上下文的使用</h2>
<p>看下这段代码，是不是很熟悉，这就是spring上下文最常见的用法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainConfig</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.创建spring上下文</span></span><br><span class="line">        AnnotationConfigApplicationContext configApplicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br><span class="line">        <span class="comment">//2.上下文中注册bean</span></span><br><span class="line">        configApplicationContext.register(MainConfig.class);</span><br><span class="line">        <span class="comment">//3.刷新spring上下文，内部会启动spring上下文</span></span><br><span class="line">        configApplicationContext.refresh();</span><br><span class="line">        <span class="comment">//4.关闭spring上下文</span></span><br><span class="line">        System.out.println(<span class="string">&quot;stop ok!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4%E3%80%81%E9%98%B6%E6%AE%B51%EF%BC%9A%E5%88%9B%E5%BB%BASpring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87"><a class="header-anchor" href="#4%E3%80%81%E9%98%B6%E6%AE%B51%EF%BC%9A%E5%88%9B%E5%BB%BASpring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87">¶</a> 4、阶段1：创建Spring应用上下文</h2>
<p>对应这段代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AnnotationConfigApplicationContext configApplicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext();</span><br></pre></td></tr></table></figure>
<p>看一下其类图，这里主要列出了<code>AnnotationConfigApplicationContext</code>2个父类</p>
<p><img src="/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/image-20220723164333042.png" alt="image-20220723164333042"></p>
<p>当调用子类的构造器的时候，默认会自动先调用父类的构造器，先来看一下<code>GenericApplicationContext</code>构造器源码，如下，将beanFactory创建好了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">GenericApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.beanFactory = <span class="keyword">new</span> DefaultListableBeanFactory();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再来看看<code>AnnotationConfigApplicationContext</code>构造器源码，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AnnotationConfigApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//创建AnnotatedBeanDefinitionReader：用来读取及注册通过注解方式定义的bean</span></span><br><span class="line">    <span class="keyword">this</span>.reader = <span class="keyword">new</span> AnnotatedBeanDefinitionReader(<span class="keyword">this</span>); <span class="comment">//@1</span></span><br><span class="line">    <span class="comment">//创建ClassPathBeanDefinitionScanner：bean定义扫描器，可以扫描包中的类，对满足条件的类，会将其注册到spring容器中</span></span><br><span class="line">    <span class="keyword">this</span>.scanner = <span class="keyword">new</span> ClassPathBeanDefinitionScanner(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@1：new AnnotatedBeanDefinitionReader(this)</code>，进入这个方法内部，最终会走到下面这个方法，非常关键的一个方法，会向spring容器中注册5个关键的bean，这几个bean都是非常很重要的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.annotation.AnnotationConfigUtils#registerAnnotationConfigProcessors(org.springframework.beans.factory.support.BeanDefinitionRegistry, java.lang.Object)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">registerAnnotationConfigProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">   BeanDefinitionRegistry registry, <span class="meta">@Nullable</span> Object source)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">	Set&lt;BeanDefinitionHolder&gt; beanDefs = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、注册ConfigurationClassPostProcessor，这是个非常关键的类，实现了BeanDefinitionRegistryPostProcessor接口</span></span><br><span class="line">    <span class="comment">// ConfigurationClassPostProcessor这个类主要做的事情：负责所有bean的注册,如果想看bean注册源码的，可以在其postProcessBeanDefinitionRegistry方法中设置断点</span></span><br><span class="line">    <span class="keyword">if</span> (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(ConfigurationClassPostProcessor.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、注册AutowiredAnnotationBeanPostProcessor：负责处理@Autowire注解</span></span><br><span class="line">    <span class="keyword">if</span> (!registry.containsBeanDefinition(AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(AutowiredAnnotationBeanPostProcessor.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3、注册CommonAnnotationBeanPostProcessor：负责处理@Resource注解</span></span><br><span class="line">    <span class="keyword">if</span> (jsr250Present &amp;&amp; !registry.containsBeanDefinition(COMMON_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(CommonAnnotationBeanPostProcessor.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, COMMON_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4、注册EventListenerMethodProcessor：负责处理@EventListener标注的方法，即事件处理器</span></span><br><span class="line">    <span class="keyword">if</span> (!registry.containsBeanDefinition(EVENT_LISTENER_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(EventListenerMethodProcessor.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_PROCESSOR_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//5、注册DefaultEventListenerFactory：负责将@EventListener标注的方法包装为ApplicationListener对象</span></span><br><span class="line">    <span class="keyword">if</span> (!registry.containsBeanDefinition(EVENT_LISTENER_FACTORY_BEAN_NAME)) &#123;</span><br><span class="line">        RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(DefaultEventListenerFactory.class);</span><br><span class="line">        def.setSource(source);</span><br><span class="line">        beanDefs.add(registerPostProcessor(registry, def, EVENT_LISTENER_FACTORY_BEAN_NAME));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> beanDefs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再来捋一下上面这段代码，主要向spring容器中注册了5个关键的bean：</p>
<p><strong>1、ConfigurationClassPostProcessor</strong>：这是个非常关键的类，建议去看一下他的源码，基本上我们自定义的bean都是通过这个类注册的，下面这些注解都是在这个类中处理的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@PropertySource</span></span><br><span class="line"><span class="meta">@PropertySources</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="meta">@ComponentScans</span></span><br><span class="line"><span class="meta">@Import</span></span><br><span class="line"><span class="meta">@ImportResource</span></span><br><span class="line"><span class="meta">@Bean</span></span><br></pre></td></tr></table></figure>
<p><strong>2、AutowiredAnnotationBeanPostProcessor</strong>：负责处理@Autowire注解</p>
<p><strong>3、注册CommonAnnotationBeanPostProcessor</strong>：负责处理@Resource注解</p>
<p><strong>4、注册EventListenerMethodProcessor</strong>：负责处理@EventListener标注的方法，即事件处理器</p>
<p><strong>5、注册DefaultEventListenerFactory</strong>：负责将@EventListener标注的方法包装为ApplicationListener对象</p>
<h2 id="4%E3%80%81%E9%98%B6%E6%AE%B52~%E9%98%B6%E6%AE%B513"><a class="header-anchor" href="#4%E3%80%81%E9%98%B6%E6%AE%B52~%E9%98%B6%E6%AE%B513">¶</a> 4、阶段2~阶段13</h2>
<p>阶段2到阶段13，这中间的12个阶段都位于refresh方法中，所以refresh方法非常很重要，需要多花时间研究这个方法。</p>
<p>refresh方法源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.support.AbstractApplicationContext#refresh</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">    <span class="comment">// 阶段2：Spring应用上下文启动准备阶段</span></span><br><span class="line">    prepareRefresh();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阶段3：BeanFactory创建阶段</span></span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阶段4：BeanFactory准备阶段</span></span><br><span class="line">    prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 阶段5：BeanFactory后置处理阶段</span></span><br><span class="line">        postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 阶段6：调用BeanFactory扩展点阶段</span></span><br><span class="line">        invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 阶段7：注册BeanPostProcessor</span></span><br><span class="line">        registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 阶段8：初始化内建Bean：MessageSource</span></span><br><span class="line">        initMessageSource();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 阶段9：初始化内建Bean：Spring事件广播器</span></span><br><span class="line">        initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 阶段10：Spring应用上下文刷新阶段，由子类实现</span></span><br><span class="line">        onRefresh();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 阶段11：Spring事件监听器注册阶段</span></span><br><span class="line">        registerListeners();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 阶段12：实例化所有剩余的（非lazy init）单例。</span></span><br><span class="line">        finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 阶段13：刷新完成阶段</span></span><br><span class="line">        finishRefresh();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="%E9%98%B6%E6%AE%B52%EF%BC%9ASpring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%90%AF%E5%8A%A8%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5"><a class="header-anchor" href="#%E9%98%B6%E6%AE%B52%EF%BC%9ASpring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%90%AF%E5%8A%A8%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5">¶</a> 阶段2：Spring应用上下文启动准备阶段</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 标记启动时间</span></span><br><span class="line">    <span class="keyword">this</span>.startupDate = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// 是否关闭：false</span></span><br><span class="line">    <span class="keyword">this</span>.closed.set(<span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// 是否启动：true</span></span><br><span class="line">    <span class="keyword">this</span>.active.set(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化PropertySource，留给子类去实现的，可以在这个方法中扩展属性配置信息，丢到this.environment中</span></span><br><span class="line">    initPropertySources();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证环境配置中是否包含必须的配置参数信息，比如我们希望上下文启动中，this.environment中必须要有某些属性的配置，才可以启动，那么可以在这个里面验证</span></span><br><span class="line">    getEnvironment().validateRequiredProperties();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// earlyApplicationListeners用来存放早期的事件监听器</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.earlyApplicationListeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.earlyApplicationListeners = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="keyword">this</span>.applicationListeners);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Reset local application listeners to pre-refresh state.</span></span><br><span class="line">        <span class="keyword">this</span>.applicationListeners.clear();</span><br><span class="line">        <span class="keyword">this</span>.applicationListeners.addAll(<span class="keyword">this</span>.earlyApplicationListeners);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// earlyApplicationEvents用来存放早期的事件</span></span><br><span class="line">    <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>这里说一下什么是早期事件？什么是早期的事件监听器呢？</strong></p>
<p>当使用spring上下文发布事件的时候，如下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">applicationContext.publishEvent(事件对象)</span><br></pre></td></tr></table></figure>
<p>其内部最终会用到<code>AbstractApplicationContext</code>下面这个属性来发布事件，但是可能此时<code>applicationEventMulticaster</code>还没有创建好，是空对象，所以此时是无法广播事件的，那么此时发布的事件就是早期的事件，就会被放在<code>this.earlyApplicationEvents</code>中暂时存放着，当时间广播器<code>applicationEventMulticaster</code>创建好了之后，才会会将早期的事件广播出去</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ApplicationEventMulticaster applicationEventMulticaster;</span><br></pre></td></tr></table></figure>
<p>同理，当<code>applicationEventMulticaster</code>还未准备好的时候，调用下面下面代码向spring上下文中添加事件监听器的时候，这时放进去的监听器就是早期的事件监听器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">applicationContext.addApplicationListener(事件监听器对象)</span><br></pre></td></tr></table></figure>
<p>说了这么多，理解起来很简单，就是当事件广播器<code>applicationEventMulticaster</code>还未准备好的时候，此时向上下文中添加的事件就是早期的事件，会被放到<code>this.earlyApplicationEvents</code>中，此时这个事件暂时没办法广播。</p>
<h3 id="%E9%98%B6%E6%AE%B53%EF%BC%9ABeanFactory%E5%88%9B%E5%BB%BA%E9%98%B6%E6%AE%B5"><a class="header-anchor" href="#%E9%98%B6%E6%AE%B53%EF%BC%9ABeanFactory%E5%88%9B%E5%BB%BA%E9%98%B6%E6%AE%B5">¶</a> 阶段3：BeanFactory创建阶段</h3>
<p>这个阶段负责将BeanFactory创建好，返回给spring应用上下文</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br></pre></td></tr></table></figure>
<p><code>obtainFreshBeanFactory</code>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ConfigurableListableBeanFactory <span class="title">obtainFreshBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//刷新BeanFactory，由子类实现</span></span><br><span class="line">    refreshBeanFactory();</span><br><span class="line">    <span class="comment">//返回spring上下文中创建好的BeanFacotry</span></span><br><span class="line">    <span class="keyword">return</span> getBeanFactory();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="%E9%98%B6%E6%AE%B54%EF%BC%9ABeanFactory%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5"><a class="header-anchor" href="#%E9%98%B6%E6%AE%B54%EF%BC%9ABeanFactory%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5">¶</a> 阶段4：BeanFactory准备阶段</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prepareBeanFactory(beanFactory);</span><br></pre></td></tr></table></figure>
<p>源码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 设置类加载器</span></span><br><span class="line">    beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line">    <span class="comment">// 设置spel表达式解析器</span></span><br><span class="line">    beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));</span><br><span class="line">    <span class="comment">// 设置属性编辑器注册器</span></span><br><span class="line">    beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> ResourceEditorRegistrar(<span class="keyword">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @1：添加一个BeanPostProcessor：ApplicationContextAwareProcessor，当你的bean实现了spring中xxxAware这样的接口，那么bean创建的过程中，将由ApplicationContextAwareProcessor来回调这些接口，将对象注入进去</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationContextAwareProcessor(<span class="keyword">this</span>));</span><br><span class="line">    <span class="comment">// @2：自动注入的时候，下面这些接口定义的方法，将会被跳过自动注入，为什么？因为这部分接口将由ApplicationContextAwareProcessor来回调注入</span></span><br><span class="line">    beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">    beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @3:注册依赖注入的时候查找的对象，比如你的bean中想用ResourceLoader，那么可以写：@Autowire private ResourceLoader resourceLoader，那么spring容器会将spring容器上下文注入进去</span></span><br><span class="line">    beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">    beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="keyword">this</span>);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="keyword">this</span>);</span><br><span class="line">    beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @4:注入一个beanpostprocessor：ApplicationListenerDetector</span></span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @5:将Environment注册到spring容器，对应的bena名称是environment</span></span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// @6:将系统属性注册到spring容器，对应的bean名称是systemProperties</span></span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// @7:将系统环境变量配置信息注入到spring容器，对应的bean名称是systemEnvironment</span></span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">        beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="%E5%85%88%E6%9D%A5%E7%9C%8B%E7%9C%8B%401%E7%9A%84%E4%BB%A3%E7%A0%81"><a class="header-anchor" href="#%E5%85%88%E6%9D%A5%E7%9C%8B%E7%9C%8B%401%E7%9A%84%E4%BB%A3%E7%A0%81">¶</a> <strong>先来看看@1的代码</strong></h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationContextAwareProcessor(<span class="keyword">this</span>));</span><br></pre></td></tr></table></figure>
<p>向spring容器中注入了一个ApplicationContextAwareProcessor，这是一个BeanPostProcessor（Bean处理器），这个接口中定义了很多方法，会在bean创建的不同阶段被调用，常用来扩展bean的创建过程。想升入了解的朋友，可以先去看一下这篇文章：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzA5MTkxMDQ4MQ==&amp;mid=2648934322&amp;idx=1&amp;sn=647edffeedeb8978c18ad403b1f3d8d7&amp;scene=21#wechat_redirect">Bean生命周期</a>。</p>
<p>在回到<code>ApplicationContextAwareProcessor</code>这个接口上来，看一下其的源码，大家就知道是干什么的，如下，当我们的bean实现了Aware这样的接口的时候，接口中的方法会被回调，用来在自定义的bean中注入spring上下文中的一些对象，比如我们在我们的bean中用到<code>Environment</code>，那么只需实现<code>EnvironmentAware</code>接口，那么<code>Environment</code>会被自动注入进去</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bean <span class="keyword">instanceof</span> EnvironmentAware) &#123;</span><br><span class="line">    ((EnvironmentAware) bean).setEnvironment(<span class="keyword">this</span>.applicationContext.getEnvironment());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (bean <span class="keyword">instanceof</span> EmbeddedValueResolverAware) &#123;</span><br><span class="line">    ((EmbeddedValueResolverAware) bean).setEmbeddedValueResolver(<span class="keyword">this</span>.embeddedValueResolver);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (bean <span class="keyword">instanceof</span> ResourceLoaderAware) &#123;</span><br><span class="line">    ((ResourceLoaderAware) bean).setResourceLoader(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (bean <span class="keyword">instanceof</span> ApplicationEventPublisherAware) &#123;</span><br><span class="line">    ((ApplicationEventPublisherAware) bean).setApplicationEventPublisher(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (bean <span class="keyword">instanceof</span> MessageSourceAware) &#123;</span><br><span class="line">    ((MessageSourceAware) bean).setMessageSource(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (bean <span class="keyword">instanceof</span> ApplicationContextAware) &#123;</span><br><span class="line">    ((ApplicationContextAware) bean).setApplicationContext(<span class="keyword">this</span>.applicationContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="%E5%86%8D%E6%9D%A5%E7%9C%8B%E7%9C%8B**%403**%E7%9A%84%E4%BB%A3%E7%A0%81"><a class="header-anchor" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B%E7%9C%8B**%403**%E7%9A%84%E4%BB%A3%E7%A0%81">¶</a> 再来看看**@3**的代码</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="keyword">this</span>);</span><br><span class="line">beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="keyword">this</span>);</span><br><span class="line">beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>这个用来向spring容器中添加依赖查找的对象，上面代码的第1行是添加了BeanFactory，当我们的bean中想用到BeanFactory的时候，只需要按照下面这么写，那么就会被自动注入，即使因为上面第1行代码将BeanFactory添加到依赖查找列表中了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowire</span></span><br><span class="line"><span class="keyword">private</span> BeanFactory beanFactory;</span><br></pre></td></tr></table></figure>
<h4 id="%E5%86%8D%E6%9D%A5%E7%9C%8B%E7%9C%8B%404%E7%9A%84%E4%BB%A3%E7%A0%81"><a class="header-anchor" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B%E7%9C%8B%404%E7%9A%84%E4%BB%A3%E7%A0%81">¶</a> 再来看看<code>@4</code>的代码</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beanFactory.addBeanPostProcessor(<span class="keyword">new</span> ApplicationListenerDetector(<span class="keyword">this</span>));</span><br></pre></td></tr></table></figure>
<p>ApplicationListenerDetector也是一个BeanPostProcessor，这个类是用于处理自定义的事件监听器的。</p>
<p>当我们的bean实现了<code>ApplicationListener</code>接口，是一个事件监听器的时候，那么这个bean创建的过程中将会被ApplicationListenerDetector处理，会将我们这个bean添加到spring上下文容器的事件监听器列表中。</p>
<p><img src="/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/640.png" alt="640"></p>
<h4 id="%E5%86%8D%E6%9D%A5%E7%9C%8B%E7%9C%8B%405%E7%9A%84%E4%BB%A3%E7%A0%81"><a class="header-anchor" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B%E7%9C%8B%405%E7%9A%84%E4%BB%A3%E7%A0%81">¶</a> 再来看看@5的代码</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">    beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将Environment作为单例注册到spring容器单例列表中，对应的bena名称是environment，当我们的bean中需要用到Environment的时候，可以使用下面的写法，此时spring容器创建bean的过程中，就会从单例的bean列表中找到Environment，将其注入到下面的属性中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowire</span></span><br><span class="line"><span class="keyword">private</span> Environment environment</span><br></pre></td></tr></table></figure>
<p>我们还可以通过<code>environment</code>名称从spring容器中查找到Environment对象，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">applicationContext.getBean(<span class="string">&quot;environment&quot;</span>, Environment.class)</span><br></pre></td></tr></table></figure>
<h4 id="%E5%86%8D%E6%9D%A5%E7%9C%8B%E7%9C%8B%406%E3%80%81%407%E4%BB%A3%E7%A0%81"><a class="header-anchor" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B%E7%9C%8B%406%E3%80%81%407%E4%BB%A3%E7%A0%81">¶</a> 再来看看@6、@7代码</h4>
<p>这个同@5的代码，这里说一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getEnvironment().getSystemProperties() -- 对应 --&gt; System.getProperties()</span><br><span class="line">getEnvironment().getSystemEnvironment() -- 对应 --&gt; System.getenv()</span><br></pre></td></tr></table></figure>
<p>这里说一下System.getProperties()、System.getenv()这两个是干嘛的。</p>
<p>下面这个命令大家都用过吧，大家主要看一下-D，这个可以设置一些启动参数，-D后面跟的这些参数，会被放在System.getProperties()中了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar -D参数=值</span><br></pre></td></tr></table></figure>
<p>System.getenv()用来获取环境变量信息的。</p>
<h3 id="%E9%98%B6%E6%AE%B55%EF%BC%9ABeanFactory%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E9%98%B6%E6%AE%B5(AbstractApplicationContext%23postProcessBeanFactory%E6%8F%90%E4%BE%9B)"><a class="header-anchor" href="#%E9%98%B6%E6%AE%B55%EF%BC%9ABeanFactory%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E9%98%B6%E6%AE%B5(AbstractApplicationContext%23postProcessBeanFactory%E6%8F%90%E4%BE%9B)">¶</a> 阶段5：BeanFactory后置处理阶段(AbstractApplicationContext#postProcessBeanFactory提供)</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postProcessBeanFactory(beanFactory);</span><br></pre></td></tr></table></figure>
<p>这个方法留给子类实现的，此时beanFactory已经创建好了，但是容器中的bean还没有被实例化，子类可以实现这个方法，可以对BeanFactory做一些特殊的配置，比如可以添加一些自定义BeanPostProcessor等等，主要是留给子类去扩展的。</p>
<h3 id="%E9%98%B6%E6%AE%B56%EF%BC%9A%E8%B0%83%E7%94%A8BeanFactoryPostProcessor%E6%89%A9%E5%B1%95%E7%82%B9%E9%98%B6%E6%AE%B5"><a class="header-anchor" href="#%E9%98%B6%E6%AE%B56%EF%BC%9A%E8%B0%83%E7%94%A8BeanFactoryPostProcessor%E6%89%A9%E5%B1%95%E7%82%B9%E9%98%B6%E6%AE%B5">¶</a> 阶段6：调用BeanFactoryPostProcessor扩展点阶段</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invokeBeanFactoryPostProcessors(beanFactory);</span><br></pre></td></tr></table></figure>
<p>调用BeanDefinitionRegistryPostProcessor、BeanFactoryPostProcessor两个接口的实现类</p>
<p>建议一定要先看一下这篇文章：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzA5MTkxMDQ4MQ==&amp;mid=2648934655&amp;idx=1&amp;sn=5b6c360de7eda0ca83d38e9db3616761&amp;scene=21#wechat_redirect">Spring系列第29篇：BeanFactory扩展（BeanFactoryPostProcessor、BeanDefinitionRegistryPostProcessor）</a></p>
<p>这个阶段主要就是从spring容器中找到BeanFactoryPostProcessor接口的所有实现类，然后调用，完成所有bean注册的功能，注意是bean注册，即将bean的定义信息转换为BeanDefinition对象，然后注册到spring容器中，此时bean还未被实例化，下面继续。</p>
<p>大家再回头看一下阶段1，阶段1在spring容器中注册了一个非常关键的bean：ConfigurationClassPostProcessor，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) &#123;</span><br><span class="line">    RootBeanDefinition def = <span class="keyword">new</span> RootBeanDefinition(ConfigurationClassPostProcessor.class);</span><br><span class="line">    def.setSource(source);</span><br><span class="line">    beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ConfigurationClassPostProcessor就实现了BeanFactoryPostProcessor接口，所以ConfigurationClassPostProcessor会在阶段6中被调用，下面这些注解都是在这个类中处理的，所以想研究下面这些注解原理的，直接看去看ConfigurationClassPostProcessor的源码，非常关键重要的一个类，研究spring源码，此类必看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@PropertySource</span></span><br><span class="line"><span class="meta">@PropertySources</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="meta">@ComponentScans</span></span><br><span class="line"><span class="meta">@Import</span></span><br><span class="line"><span class="meta">@ImportResource</span></span><br><span class="line"><span class="meta">@Bean</span></span><br></pre></td></tr></table></figure>
<h4 id="1.processConfigBeanDefinitions()%E5%89%8D%E5%8D%8A%E6%AE%B5"><a class="header-anchor" href="#1.processConfigBeanDefinitions()%E5%89%8D%E5%8D%8A%E6%AE%B5">¶</a> 1.processConfigBeanDefinitions()前半段</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processConfigBeanDefinitions</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">    List&lt;BeanDefinitionHolder&gt; configCandidates = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    String[] candidateNames = registry.getBeanDefinitionNames();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (String beanName : candidateNames) &#123;</span><br><span class="line">        BeanDefinition beanDef = registry.getBeanDefinition(beanName);</span><br><span class="line">        <span class="comment">// configurationClass已经有值(full/lite)了则跳过</span></span><br><span class="line">        <span class="keyword">if</span> (beanDef.getAttribute(ConfigurationClassUtils.CONFIGURATION_CLASS_ATTRIBUTE) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;Bean definition has already been processed as a configuration class: &quot;</span> + beanDef);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// @1：判断是否是配置类，会标注是full/lite全配置类等</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, <span class="keyword">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line">            configCandidates.add(<span class="keyword">new</span> BeanDefinitionHolder(beanDef, beanName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (configCandidates.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @1 checkConfigurationClassCandidate主要代码</span></span><br><span class="line">Map&lt;String, Object&gt; config = metadata.getAnnotationAttributes(Configuration.class.getName());</span><br><span class="line"><span class="keyword">if</span> (config != <span class="keyword">null</span> &amp;&amp; !Boolean.FALSE.equals(config.get(<span class="string">&quot;proxyBeanMethods&quot;</span>))) &#123;</span><br><span class="line">    <span class="comment">// full配置类</span></span><br><span class="line">    beanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_FULL);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (config != <span class="keyword">null</span> || isConfigurationCandidate(metadata)) &#123;</span><br><span class="line">    <span class="comment">// lite配置类</span></span><br><span class="line">    beanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_LITE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/image-20220808173406936.png" alt="image-20220808173406936"></p>
<h4 id="2.processConfigBeanDefinitions()%E5%90%8E%E5%8D%8A%E6%AE%B5"><a class="header-anchor" href="#2.processConfigBeanDefinitions()%E5%90%8E%E5%8D%8A%E6%AE%B5">¶</a> 2.processConfigBeanDefinitions()后半段</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于解析各个配置类</span></span><br><span class="line">ConfigurationClassParser parser = <span class="keyword">new</span> ConfigurationClassParser(</span><br><span class="line">    <span class="keyword">this</span>.metadataReaderFactory, <span class="keyword">this</span>.problemReporter, <span class="keyword">this</span>.environment,</span><br><span class="line">    <span class="keyword">this</span>.resourceLoader, <span class="keyword">this</span>.componentScanBeanNameGenerator, registry);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将之前加入的configCandidates去重</span></span><br><span class="line">Set&lt;BeanDefinitionHolder&gt; candidates = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(configCandidates);</span><br><span class="line"><span class="comment">// 用于判断是否处理过</span></span><br><span class="line">Set&lt;ConfigurationClass&gt; alreadyParsed = <span class="keyword">new</span> HashSet&lt;&gt;(configCandidates.size());</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// 解析配置类</span></span><br><span class="line">    parser.parse(candidates);</span><br><span class="line">    parser.validate();</span><br><span class="line"></span><br><span class="line">    Set&lt;ConfigurationClass&gt; configClasses = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(parser.getConfigurationClasses());</span><br><span class="line">    configClasses.removeAll(alreadyParsed);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read the model and create bean definitions based on its content</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.reader == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.reader = <span class="keyword">new</span> ConfigurationClassBeanDefinitionReader(</span><br><span class="line">            registry, <span class="keyword">this</span>.sourceExtractor, <span class="keyword">this</span>.resourceLoader, <span class="keyword">this</span>.environment,</span><br><span class="line">            <span class="keyword">this</span>.importBeanNameGenerator, parser.getImportRegistry());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.reader.loadBeanDefinitions(configClasses);</span><br><span class="line">    alreadyParsed.addAll(configClasses);</span><br><span class="line"></span><br><span class="line">    candidates.clear();</span><br><span class="line">    <span class="keyword">if</span> (registry.getBeanDefinitionCount() &gt; candidateNames.length) &#123;</span><br><span class="line">        String[] newCandidateNames = registry.getBeanDefinitionNames();</span><br><span class="line">        Set&lt;String&gt; oldCandidateNames = <span class="keyword">new</span> HashSet&lt;&gt;(Arrays.asList(candidateNames));</span><br><span class="line">        Set&lt;String&gt; alreadyParsedClasses = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ConfigurationClass configurationClass : alreadyParsed) &#123;</span><br><span class="line">            alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断新注册的bean有否是配置类</span></span><br><span class="line">        <span class="keyword">for</span> (String candidateName : newCandidateNames) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!oldCandidateNames.contains(candidateName)) &#123;</span><br><span class="line">                BeanDefinition bd = registry.getBeanDefinition(candidateName);</span><br><span class="line">                <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, <span class="keyword">this</span>.metadataReaderFactory) &amp;&amp;</span><br><span class="line">                    !alreadyParsedClasses.contains(bd.getBeanClassName())) &#123;</span><br><span class="line">                    candidates.add(<span class="keyword">new</span> BeanDefinitionHolder(bd, candidateName));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        candidateNames = newCandidateNames;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> (!candidates.isEmpty());</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parse调用链路</span></span><br><span class="line">ConfigurationClassParser#parse(Set&lt;BeanDefinitionHolder&gt;);</span><br><span class="line">ConfigurationClassParser#parse(AnnotationMetadata metadata, String beanName);</span><br><span class="line">ConfigurationClassParser#processConfigurationClass(ConfigurationClass, Predicate&lt;String&gt;);</span><br><span class="line">ConfigurationClassParser#doProcessConfigurationClass(ConfigurationClass, SourceClass, Predicate&lt;String&gt;); //处理前面所说的@Component、@PropertySources、@ComponentScans、@ComponentScan、@Import、@ImportResource、@Bean等注解</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="3.postProcessBeanFactory"><a class="header-anchor" href="#3.postProcessBeanFactory">¶</a> 3.postProcessBeanFactory</h4>
<p>​	主要是给@Configuration配置类产生cglib代理，并添加了一个<code>ImportAwareBeanPostProcessor</code>后置处理器</p>
<p><strong>通常，阶段6执行完毕之后，我们所有自定义的bean都已经被注册到spring容器中了，被转换为BeanDefinition丢到BeanFactory中了，此时bean还未被实例化。</strong></p>
<h3 id="%E9%98%B6%E6%AE%B57%EF%BC%9A%E6%B3%A8%E5%86%8CBeanPostProcessor"><a class="header-anchor" href="#%E9%98%B6%E6%AE%B57%EF%BC%9A%E6%B3%A8%E5%86%8CBeanPostProcessor">¶</a> 阶段7：注册BeanPostProcessor</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registerBeanPostProcessors(beanFactory);</span><br></pre></td></tr></table></figure>
<p>注册BeanPostProcessor，这个阶段会遍历spring容器bean定义列表，把所有实现了<strong>BeanPostProcessor</strong>接口的bean拿出来，然后将他们添加到spring容器的BeanPostProcessor列表中。</p>
<p>BeanPostProcessor是bean后置处理器，其内部提供了很多方法，用来对bean创建的过程进行扩展的。</p>
<h3 id="%E9%98%B6%E6%AE%B58%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E5%86%85%E5%BB%BABean%EF%BC%9AMessageSource"><a class="header-anchor" href="#%E9%98%B6%E6%AE%B58%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E5%86%85%E5%BB%BABean%EF%BC%9AMessageSource">¶</a> 阶段8：初始化内建Bean：MessageSource</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initMessageSource();</span><br></pre></td></tr></table></figure>
<p>MessageSource 是用来处理国际化的，这个阶段会将MessageSource创建好，如果想扩展或者实现国家化的，可以看看这个方法的源码。</p>
<p>关于国际化的可以看这篇文章：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzA5MTkxMDQ4MQ==&amp;mid=2648934484&amp;idx=1&amp;sn=ef0a704c891f318a7c23fe000d9003d5&amp;scene=21#wechat_redirect">Spring系列第26篇：国际化详解</a></p>
<h3 id="%E9%98%B6%E6%AE%B59%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E5%86%85%E5%BB%BABean%EF%BC%9ASpring%E4%BA%8B%E4%BB%B6%E5%B9%BF%E6%92%AD%E5%99%A8"><a class="header-anchor" href="#%E9%98%B6%E6%AE%B59%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E5%86%85%E5%BB%BABean%EF%BC%9ASpring%E4%BA%8B%E4%BB%B6%E5%B9%BF%E6%92%AD%E5%99%A8">¶</a> 阶段9：初始化内建Bean：Spring事件广播器</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initApplicationEventMulticaster();</span><br></pre></td></tr></table></figure>
<p>ApplicationEventMulticaster是事件广播器，用来广播事件的，这个阶段会将ApplicationEventMulticaster创建好，如果想自定义事件广播器的，可以看看这个方法的源码，关于spring事件的使用，看这里：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzA5MTkxMDQ4MQ==&amp;mid=2648934522&amp;idx=1&amp;sn=7653141d01b260875797bbf1305dd196&amp;scene=21#wechat_redirect">Spring系列第27篇：spring事件机制详解</a>。</p>
<h3 id="%E9%98%B6%E6%AE%B510%EF%BC%9ASpring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%B7%E6%96%B0%E9%98%B6%E6%AE%B5%EF%BC%8C%E7%94%B1%E5%AD%90%E7%B1%BB%E5%AE%9E%E7%8E%B0"><a class="header-anchor" href="#%E9%98%B6%E6%AE%B510%EF%BC%9ASpring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%B7%E6%96%B0%E9%98%B6%E6%AE%B5%EF%BC%8C%E7%94%B1%E5%AD%90%E7%B1%BB%E5%AE%9E%E7%8E%B0">¶</a> 阶段10：Spring应用上下文刷新阶段，由子类实现</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onRefresh();</span><br></pre></td></tr></table></figure>
<p>用来初始化其他特殊的bean，由子类去实现。</p>
<h3 id="%E9%98%B6%E6%AE%B511%EF%BC%9ASpring%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%99%A8%E6%B3%A8%E5%86%8C%E9%98%B6%E6%AE%B5"><a class="header-anchor" href="#%E9%98%B6%E6%AE%B511%EF%BC%9ASpring%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%99%A8%E6%B3%A8%E5%86%8C%E9%98%B6%E6%AE%B5">¶</a> 阶段11：Spring事件监听器注册阶段</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registerListeners();</span><br></pre></td></tr></table></figure>
<p>注册事件监听器到事件广播器中，看一下其源码，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// @1:先注册静态指定的侦听器,即将spring上下文中添加的时间监听器，添加到时间广播器（ApplicationEventMulticaster）中</span></span><br><span class="line">    <span class="keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;</span><br><span class="line">        getApplicationEventMulticaster().addApplicationListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @2:将spring容器中定义的事件监听器，添加到时间广播器（ApplicationEventMulticaster）中</span></span><br><span class="line">    String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">for</span> (String listenerBeanName : listenerBeanNames) &#123;</span><br><span class="line">        getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @3:此时事件广播器准备好了，所以此时发布早期的事件（早期的事件由于事件广播器还未被创建，所以先被放在了earlyApplicationEvents中，而此时广播器创建好了，所以将早期的时间发布一下）</span></span><br><span class="line">    Set&lt;ApplicationEvent&gt; earlyEventsToProcess = <span class="keyword">this</span>.earlyApplicationEvents;</span><br><span class="line">    <span class="keyword">this</span>.earlyApplicationEvents = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (earlyEventsToProcess != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123;</span><br><span class="line">            getApplicationEventMulticaster().multicastEvent(earlyEvent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>这里主要说一下@1</strong>，将上下文中的事件监听器添加到事件广播器中，看看下面源码就懂了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.support.AbstractApplicationContext</span><br><span class="line"></span><br><span class="line">Set&lt;ApplicationListener&lt;?&gt;&gt; applicationListeners = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Collection&lt;ApplicationListener&lt;?&gt;&gt; getApplicationListeners() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.applicationListeners;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addApplicationListener</span><span class="params">(ApplicationListener&lt;?&gt; listener)</span> </span>&#123;</span><br><span class="line">    Assert.notNull(listener, <span class="string">&quot;ApplicationListener must not be null&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.applicationEventMulticaster != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationEventMulticaster.addApplicationListener(listener);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.applicationListeners.add(listener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再来看看@3，广播早期的事件，早期的时候，由于事件广播器<code>this.applicationEventMulticaster</code>还是空，所以事件被放在了<code>this.earlyApplicationEvents</code>这个集合中并没有广播，等到这个时候才广播早期的事件，所以用事件的时候，大家需要注意，如果你在阶段11之前，调用了下面方法发布事件，那么可能此时你看不到事件产生的效果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">applicationContext.publishEvent(事件对象)</span><br></pre></td></tr></table></figure>
<p>所以如果你的bean实现了下面这些接口，不建议再实现<code>org.springframework.context.ApplicationListener</code>接口，否则会让你莫名其妙的感觉。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.beans.factory.config.BeanFactoryPostProcessor</span><br><span class="line">org.springframework.beans.factory.config.BeanPostProcessor</span><br></pre></td></tr></table></figure>
<h3 id="%E9%98%B6%E6%AE%B512%EF%BC%9A%E5%AE%9E%E4%BE%8B%E5%8C%96%E6%89%80%E6%9C%89%E5%89%A9%E4%BD%99%E7%9A%84%EF%BC%88%E9%9D%9Elazy%20init%EF%BC%89%E5%8D%95%E4%BE%8B"><a class="header-anchor" href="#%E9%98%B6%E6%AE%B512%EF%BC%9A%E5%AE%9E%E4%BE%8B%E5%8C%96%E6%89%80%E6%9C%89%E5%89%A9%E4%BD%99%E7%9A%84%EF%BC%88%E9%9D%9Elazy%20init%EF%BC%89%E5%8D%95%E4%BE%8B">¶</a> 阶段12：实例化所有剩余的（非lazy init）单例</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">finishBeanFactoryInitialization(beanFactory);</span><br></pre></td></tr></table></figure>
<p><strong>这个方法中将实例化所有单例的bean（不包需要延迟实例化的bean）</strong>，来看看其源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 添加$&#123;&#125;表达式解析器</span></span><br><span class="line">    <span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line">        beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 冻结所有bean定义，表示已注册的bean定义不会被进一步修改或后处理。这允许工厂主动缓存bean定义元数据。</span></span><br><span class="line">    beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @1：实例化所有单例bean（不包含需延迟实例化的bean），通常scope=singleton的bean都会在下面这个方法中完成初始化。</span></span><br><span class="line">    beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重点看<code>@1</code>的代码，这里会调用<code>beanFactory的preInstantiateSingletons()</code>方法，进去看源码，源码位于<code>DefaultListableBeanFactory</code>这个类中，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.beans.factory.support.DefaultListableBeanFactory#preInstantiateSingletons</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">    <span class="comment">// beanDefinitionNames表示当前BeanFactory中定义的bean名称列表，</span></span><br><span class="line">    List&lt;String&gt; beanNames = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.beanDefinitionNames);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @1：循环实例化bean</span></span><br><span class="line">    <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">        <span class="comment">//这里根据beanName来来实例化bean，代码省略了。。。。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @2：遍历bean，若bean实现了SmartInitializingSingleton接口，将调用其afterSingletonsInstantiated()方法</span></span><br><span class="line">    <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">        Object singletonInstance = getSingleton(beanName);</span><br><span class="line">        <span class="keyword">if</span> (singletonInstance <span class="keyword">instanceof</span> SmartInitializingSingleton) &#123;</span><br><span class="line">            SmartInitializingSingleton smartSingleton = (SmartInitializingSingleton) singletonInstance;</span><br><span class="line">            <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">                    smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;, getAccessControlContext());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这个方法主要做了2个事情：</p>
<p>1、完成所有单例bean的实例化：对应上面的代码<code>@1</code>，循环遍历beanNames列表，完成所有单例bean的实例化工作，这个循环完成之后，所有单例bean已经实例化完毕了，被放在spring容器缓存起来了。</p>
<p>2、回调<code>SmartInitializingSingleton</code>接口：对应上面的代码<code>@2</code>，此时所有的单例bean已经实例化好了，此时遍历所有单例bean，若bean实现了<code>SmartInitializingSingleton</code>接口，这个接口中有个<code>afterSingletonsInstantiated方法</code>，此时会回调这个方法，若我们想在所有单例bean创建完毕之后，做一些事情，可以实现这个接口。</p>
<p>实例化的主要几个工作：</p>
<ul>
<li>Bean实例化阶段：会通过反射来调用bean的构造器来创建bean的实例</li>
<li>Bean属性赋值阶段：依赖注入，解析@Resource、@Autowired、@Value等注解</li>
<li>Bean初始化阶段：Aware接口回调、BeanPostProcessor接口回调</li>
<li>AOP入口</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AbstractBeanFactory#doGetBean(String name, @Nullable Class&lt;T&gt; requiredType, @Nullable Object[] args, boolean typeCheckOnly);</span><br><span class="line">AbstractAutowireCapableBeanFactory#doCreateBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)</span><br></pre></td></tr></table></figure>
<p><img src="/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/image-20220810234338026.png" alt="image-20220810234338026"></p>
<p align="center">BeanPostProcessor接口回调</p>
<h3 id="%E9%98%B6%E6%AE%B513%EF%BC%9A%E5%88%B7%E6%96%B0%E5%AE%8C%E6%88%90%E9%98%B6%E6%AE%B5"><a class="header-anchor" href="#%E9%98%B6%E6%AE%B513%EF%BC%9A%E5%88%B7%E6%96%B0%E5%AE%8C%E6%88%90%E9%98%B6%E6%AE%B5">¶</a> 阶段13：刷新完成阶段</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">finishRefresh();</span><br></pre></td></tr></table></figure>
<p>进去看看其源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finishRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// @1：清理一些资源缓存</span></span><br><span class="line">    clearResourceCaches();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @2：为此上下文初始化生命周期处理器</span></span><br><span class="line">    initLifecycleProcessor();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @3：首先将刷新传播到生命周期处理器</span></span><br><span class="line">    getLifecycleProcessor().onRefresh();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @4：发布ContextRefreshedEvent事件</span></span><br><span class="line">    publishEvent(<span class="keyword">new</span> ContextRefreshedEvent(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="%E5%85%88%E6%9D%A5%E7%9C%8B%402%E7%9A%84%E4%BB%A3%E7%A0%81"><a class="header-anchor" href="#%E5%85%88%E6%9D%A5%E7%9C%8B%402%E7%9A%84%E4%BB%A3%E7%A0%81">¶</a> 先来看@2的代码</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initLifecycleProcessor();</span><br></pre></td></tr></table></figure>
<p>源码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initLifecycleProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">    <span class="comment">//spring容器中是否有名称为&quot;lifecycleProcessor&quot;的bean</span></span><br><span class="line">    <span class="keyword">if</span> (beanFactory.containsLocalBean(<span class="string">&quot;lifecycleProcessor&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">//从spring容器中找到LifecycleProcessor，赋给this.lifecycleProcessor</span></span><br><span class="line">        <span class="keyword">this</span>.lifecycleProcessor =</span><br><span class="line">            beanFactory.getBean(<span class="string">&quot;lifecycleProcessor&quot;</span>, LifecycleProcessor.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//如果spring容器中没有自定义lifecycleProcessor，那么创建一个默认的DefaultLifecycleProcessor</span></span><br><span class="line">        DefaultLifecycleProcessor defaultProcessor = <span class="keyword">new</span> DefaultLifecycleProcessor();</span><br><span class="line">        defaultProcessor.setBeanFactory(beanFactory);</span><br><span class="line">        <span class="comment">//设置当前spring应用上下文的生命周期处理器</span></span><br><span class="line">        <span class="keyword">this</span>.lifecycleProcessor = defaultProcessor;</span><br><span class="line">        <span class="comment">//将其注册到spring容器中</span></span><br><span class="line">        beanFactory.registerSingleton(<span class="string">&quot;lifecycleProcessor&quot;</span>, <span class="keyword">this</span>.lifecycleProcessor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="%E5%86%8D%E6%9D%A5%E7%9C%8B%403%E7%9A%84%E4%BB%A3%E7%A0%81"><a class="header-anchor" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B%403%E7%9A%84%E4%BB%A3%E7%A0%81">¶</a> 再来看@3的代码</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getLifecycleProcessor().onRefresh();</span><br></pre></td></tr></table></figure>
<p>调用<code>LifecycleProcessor</code>的<code>onRefresh方法</code>， 这里要先说一下<code>org.springframework.context.LifecycleProcessor</code>这个接口，生命周期处理器，接口中定义了2个方法，而<code>onClose</code>方法会在上下文关闭中会被调用，稍后会看到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LifecycleProcessor</span> <span class="keyword">extends</span> <span class="title">Lifecycle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 上下文刷新通知</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 上下文关闭通知</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">onClose</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先来看看onRefresh方法，这个接口有个默认实现<code>org.springframework.context.support.DefaultLifecycleProcessor</code>，所以默认情况下，我们就看<code>DefaultLifecycleProcessor</code>中的<code>onRefresh</code>源码，如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    startBeans(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">this</span>.running = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入<code>startBeans(true)</code>内部看看，如下，代码看起来可能有点绕，实际上很简单，就是从容器中找到所有实现<code>org.springframework.context.Lifecycle</code>接口的bean，然后调用他们的<code>start</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBeans</span><span class="params">(<span class="keyword">boolean</span> autoStartupOnly)</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Lifecycle&gt; lifecycleBeans = getLifecycleBeans();</span><br><span class="line">    Map&lt;Integer, LifecycleGroup&gt; phases = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    lifecycleBeans.forEach((beanName, bean) -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!autoStartupOnly || (bean <span class="keyword">instanceof</span> SmartLifecycle &amp;&amp; ((SmartLifecycle) bean).isAutoStartup())) &#123;</span><br><span class="line">            <span class="keyword">int</span> phase = getPhase(bean);</span><br><span class="line">            LifecycleGroup group = phases.get(phase);</span><br><span class="line">            <span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                group = <span class="keyword">new</span> LifecycleGroup(phase, <span class="keyword">this</span>.timeoutPerShutdownPhase, lifecycleBeans, autoStartupOnly);</span><br><span class="line">                phases.put(phase, group);</span><br><span class="line">            &#125;</span><br><span class="line">            group.add(beanName, bean);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!phases.isEmpty()) &#123;</span><br><span class="line">        List&lt;Integer&gt; keys = <span class="keyword">new</span> ArrayList&lt;&gt;(phases.keySet());</span><br><span class="line">        Collections.sort(keys);</span><br><span class="line">        <span class="keyword">for</span> (Integer key : keys) &#123;</span><br><span class="line">            phases.get(key).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="%E5%86%8D%E6%9D%A5%E7%9C%8B%404%E7%9A%84%E4%BB%A3%E7%A0%81"><a class="header-anchor" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B%404%E7%9A%84%E4%BB%A3%E7%A0%81">¶</a> 再来看@4的代码</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">publishEvent(<span class="keyword">new</span> ContextRefreshedEvent(<span class="keyword">this</span>));</span><br></pre></td></tr></table></figure>
<p>发布<code>ContextRefreshedEvent</code>事件，想在这个阶段做点事情的，可以监听这个事件。</p>
<h4 id="%E5%B0%8F%E7%BB%93%E4%B8%8B"><a class="header-anchor" href="#%E5%B0%8F%E7%BB%93%E4%B8%8B">¶</a> 小结下</h4>
<p>这个阶段主要干了3个事情：</p>
<p>1、初始化当前上下文中的生命周期处理器LifecycleProcessor。</p>
<p>2、调用LifecycleProcessor.onRefresh()方法，若没有自定义<code>LifecycleProcessor</code>，那么会走<code>DefaultLifecycleProcessor</code>，其内部会调用spring容器中所有实现<code>Lifecycle</code>接口的bean的<code>start</code>方法。</p>
<p>3、发布ContextRefreshedEvent事件。</p>
<h2 id="4%E3%80%81%E9%98%B6%E6%AE%B514%EF%BC%9ASpring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%85%B3%E9%97%AD%E9%98%B6%E6%AE%B5"><a class="header-anchor" href="#4%E3%80%81%E9%98%B6%E6%AE%B514%EF%BC%9ASpring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%85%B3%E9%97%AD%E9%98%B6%E6%AE%B5">¶</a> 4、阶段14：Spring应用上下文关闭阶段</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">applicationContext.close()</span><br></pre></td></tr></table></figure>
<p>最终会进入到<code>doClouse()</code>方法，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.support.AbstractApplicationContext#doClose</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断是不是需要关闭（active为tue的时候，才能关闭，并用cas确保并发情况下只能有一个执行成功）</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.active.get() &amp;&amp; <span class="keyword">this</span>.closed.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//发布关闭事件ContextClosedEvent</span></span><br><span class="line">        publishEvent(<span class="keyword">new</span> ContextClosedEvent(<span class="keyword">this</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// @1：调用生命周期处理器的onClose方法</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.lifecycleProcessor != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.lifecycleProcessor.onClose();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// @2：销毁上下文的BeanFactory中所有缓存的单例</span></span><br><span class="line">        destroyBeans();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// @3：关闭BeanFactory本身</span></span><br><span class="line">        closeBeanFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 留给子类去扩展的</span></span><br><span class="line">        onClose();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 恢复事件监听器列表至刷新之前的状态，即将早期的事件监听器还原</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.earlyApplicationListeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.applicationListeners.clear();</span><br><span class="line">            <span class="keyword">this</span>.applicationListeners.addAll(<span class="keyword">this</span>.earlyApplicationListeners);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 标记活动状态为：false</span></span><br><span class="line">        <span class="keyword">this</span>.active.set(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="%E5%86%8D%E6%9D%A5%E7%9C%8B%401%E7%9A%84%E4%BB%A3%E7%A0%81"><a class="header-anchor" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B%401%E7%9A%84%E4%BB%A3%E7%A0%81">¶</a> 再来看@1的代码</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.lifecycleProcessor != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.lifecycleProcessor.onClose();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用生命周期处理器的<code>onClose</code>方法，这里我们直接看<code>DefaultLifecycleProcessor</code>的<code>onClose()</code>，看看其源码，如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    stopBeans();</span><br><span class="line">    <span class="comment">//将running设置为false</span></span><br><span class="line">    <span class="keyword">this</span>.running = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>stopBeans()</code>源码如下，一大片，简单点理解：就是从容器中找到所有实现<code>org.springframework.context.Lifecycle</code>接口的bean，然后调用他们的<code>stop()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopBeans</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Lifecycle&gt; lifecycleBeans = getLifecycleBeans();</span><br><span class="line">    Map&lt;Integer, LifecycleGroup&gt; phases = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    lifecycleBeans.forEach((beanName, bean) -&gt; &#123;</span><br><span class="line">        <span class="keyword">int</span> shutdownPhase = getPhase(bean);</span><br><span class="line">        LifecycleGroup group = phases.get(shutdownPhase);</span><br><span class="line">        <span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123;</span><br><span class="line">            group = <span class="keyword">new</span> LifecycleGroup(shutdownPhase, <span class="keyword">this</span>.timeoutPerShutdownPhase, lifecycleBeans, <span class="keyword">false</span>);</span><br><span class="line">            phases.put(shutdownPhase, group);</span><br><span class="line">        &#125;</span><br><span class="line">        group.add(beanName, bean);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!phases.isEmpty()) &#123;</span><br><span class="line">        List&lt;Integer&gt; keys = <span class="keyword">new</span> ArrayList&lt;&gt;(phases.keySet());</span><br><span class="line">        keys.sort(Collections.reverseOrder());</span><br><span class="line">        <span class="keyword">for</span> (Integer key : keys) &#123;</span><br><span class="line">            phases.get(key).stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="%E5%86%8D%E6%9D%A5%E7%9C%8B%402%E7%9A%84%E4%BB%A3%E7%A0%81"><a class="header-anchor" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B%402%E7%9A%84%E4%BB%A3%E7%A0%81">¶</a> 再来看@2的代码</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">destroyBeans();</span><br></pre></td></tr></table></figure>
<p>销毁上下文的BeanFactory中所有缓存的单例bean，主要干2件事情：</p>
<p><strong>1、调用bean的销毁方法</strong></p>
<p>比如bean实现了<code>org.springframework.beans.factory.DisposableBean</code>接口，此时会被调用。还有bean中有些方法标注了<code>@PreDestroy</code>注解的，此时也会被调用。</p>
<p><strong>2、将bean的信息从BeanFactory中清理掉</strong></p>
<h3 id="%E5%86%8D%E6%9D%A5%E7%9C%8B%403%E7%9A%84%E4%BB%A3%E7%A0%81-2"><a class="header-anchor" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B%403%E7%9A%84%E4%BB%A3%E7%A0%81-2">¶</a> 再来看@3的代码</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">closeBeanFactory();</span><br></pre></td></tr></table></figure>
<p>源码如下，主要就是想当前spring应用上下文中的beanFactory属性还原。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.support.AbstractRefreshableApplicationContext#closeBeanFactory</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">closeBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanFactoryMonitor) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.beanFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.beanFactory.setSerializationId(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.beanFactory = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5%E3%80%81%E6%80%BB%E7%BB%93"><a class="header-anchor" href="#5%E3%80%81%E6%80%BB%E7%BB%93">¶</a> 5、总结</h2>
<p>本文详细介绍了spring应用上下文的生命周期，建议大家结合源码多看几遍，同时有许多关键的实现类这里只是简单提了其作用，感兴趣的也可以多了解下他们的实现原理，平时闲的时候，也可以回头再看几遍，加深理解。</p>
<script>
    let imgs = document.getElementsByTagName('img');
    for (let img of imgs) {
        img.setAttribute('class', 'fancybox');
    }
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css">
      
        <div class="mdui-m-y-2 mdui-text-center">
          <button class="mdui-fab mdui-color-deep-orange mdui-text-color-white mdui-ripple" mdui-dialog="{target: '#donate'}" mdui-tooltip="{content: '打赏', position: 'top'}"><i class="mdui-icon material-icons">thumb_up</i></button>
        </div>
      
      <blockquote>
        
        <strong>本文链接：</strong><br><a href="http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/">http://lampkins.gitee.io/2022/02/10/Spring%E4%B8%8A%E4%B8%8B%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/</a>
      </blockquote>
    </div>
    <footer class="mdui-card-actions">
      
        <a class="mdui-ripple article_categories-link" href="/categories/Java/">Java</a>
      
      
        <a class="mdui-ripple article_tags-link" href="/tags/Spring/" rel="tag">Spring</a>
      
    </footer>
    
      <div class="mdui-dialog" id="donate">
        <div class="mdui-tab mdui-tab-centered">
          
            <a href="#donate-0" class="mdui-ripple">QQ支付</a>
          
            <a href="#donate-1" class="mdui-ripple">支付宝</a>
          
        </div>
        
        
          <div id="donate-0" class="mdui-p-a-2 mdui-typo mdui-text-center">
            
              <img src="/images/qqpay.jpg" style="width: 300px;">
            
          </div>
        
          <div id="donate-1" class="mdui-p-a-2 mdui-typo mdui-text-center">
            
              <img src="/images/alipay.jpg" style="width: 300px;">
            
          </div>
        
      </div>
    
  </article>
  
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>

  <script>$("#main article .mdui-card-content img.fancybox").on("click",function(e){$.fancybox.open({src:$(this).attr("src")});});</script>


  <nav id="paginator">
    
      <a rel="prev" class="extend prev" href="/2022/02/11/Spring-AOP%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E3%80%81%E5%8E%9F%E7%90%86/">
        <button aria-label="prev" class="mdui-btn mdui-btn-raised mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_back</i></button>
        <span class="mdui-p-x-3" mdui-tooltip="{content: 'Spring AOP核心源码、原理'}">上一篇</span>
      </a>
    
    <div class="spacer"></div>
    
      <a rel="next" class="extend next" href="/2021/08/03/logtail%E9%87%87%E9%9B%86%E9%85%8D%E7%BD%AE/">
        <span class="mdui-p-x-3" mdui-tooltip="{content: 'logtail采集配置'}">下一篇</span>
        <button aria-label="next" class="mdui-btn mdui-btn-raised mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_forward</i></button>
      </a>
    
  </nav>


  <div id="comment" class="mdui-m-t-5 mdui-m-x-1">
    <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
  var gitalk = new Gitalk({
    clientID: 'd17f668bcd7f140d735f',
    clientSecret: '3058f2300347db4f27a87d10648565e8d0549033',
    repo: 'Lampkins.github.io',
    owner: 'lampkins',
    admin: ['lampkins'],
    id: '294947ce-81b6-e927-771b-df367e7cdfb7' || location.pathname,
    proxy: 'https://proxy.cors.sh/https://github.com/login/oauth/access_token',
    distractionFreeMode: false
  });
  gitalk.render('gitalk-container');
</script>
  </div>



  <div style="position: fixed !important; right: 16px; top: 30%;">
    <button class="mdui-fab mdui-fab-mini mdui-ripple" mdui-menu="{target: '#toc'}"><i class="mdui-icon material-icons">toc</i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item" disabled><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFspring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%9F"><span class="toc-text"> 1、什么是spring应用上下文？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%BA%94%E7%94%A8%E4%B8%8A%E6%96%87%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F(14%E4%B8%AA%E9%98%B6%E6%AE%B5)"><span class="toc-text"> 2、应用上文生命周期(14个阶段)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81Spring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text"> 3、Spring应用上下文的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E9%98%B6%E6%AE%B51%EF%BC%9A%E5%88%9B%E5%BB%BASpring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-text"> 4、阶段1：创建Spring应用上下文</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E9%98%B6%E6%AE%B52~%E9%98%B6%E6%AE%B513"><span class="toc-text"> 4、阶段2~阶段13</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B52%EF%BC%9ASpring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%90%AF%E5%8A%A8%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5"><span class="toc-text"> 阶段2：Spring应用上下文启动准备阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B53%EF%BC%9ABeanFactory%E5%88%9B%E5%BB%BA%E9%98%B6%E6%AE%B5"><span class="toc-text"> 阶段3：BeanFactory创建阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B54%EF%BC%9ABeanFactory%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5"><span class="toc-text"> 阶段4：BeanFactory准备阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%88%E6%9D%A5%E7%9C%8B%E7%9C%8B@1%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text"> 先来看看@1的代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B%E7%9C%8B**@3**%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text"> 再来看看**@3**的代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B%E7%9C%8B@4%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text"> 再来看看@4的代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B%E7%9C%8B@5%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text"> 再来看看@5的代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B%E7%9C%8B@6%E3%80%81@7%E4%BB%A3%E7%A0%81"><span class="toc-text"> 再来看看@6、@7代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B55%EF%BC%9ABeanFactory%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E9%98%B6%E6%AE%B5(AbstractApplicationContext#postProcessBeanFactory%E6%8F%90%E4%BE%9B)"><span class="toc-text"> 阶段5：BeanFactory后置处理阶段(AbstractApplicationContext#postProcessBeanFactory提供)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B56%EF%BC%9A%E8%B0%83%E7%94%A8BeanFactoryPostProcessor%E6%89%A9%E5%B1%95%E7%82%B9%E9%98%B6%E6%AE%B5"><span class="toc-text"> 阶段6：调用BeanFactoryPostProcessor扩展点阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1.processConfigBeanDefinitions()%E5%89%8D%E5%8D%8A%E6%AE%B5"><span class="toc-text"> 1.processConfigBeanDefinitions()前半段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2.processConfigBeanDefinitions()%E5%90%8E%E5%8D%8A%E6%AE%B5"><span class="toc-text"> 2.processConfigBeanDefinitions()后半段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3.postProcessBeanFactory"><span class="toc-text"> 3.postProcessBeanFactory</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B57%EF%BC%9A%E6%B3%A8%E5%86%8CBeanPostProcessor"><span class="toc-text"> 阶段7：注册BeanPostProcessor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B58%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E5%86%85%E5%BB%BABean%EF%BC%9AMessageSource"><span class="toc-text"> 阶段8：初始化内建Bean：MessageSource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B59%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E5%86%85%E5%BB%BABean%EF%BC%9ASpring%E4%BA%8B%E4%BB%B6%E5%B9%BF%E6%92%AD%E5%99%A8"><span class="toc-text"> 阶段9：初始化内建Bean：Spring事件广播器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B510%EF%BC%9ASpring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%B7%E6%96%B0%E9%98%B6%E6%AE%B5%EF%BC%8C%E7%94%B1%E5%AD%90%E7%B1%BB%E5%AE%9E%E7%8E%B0"><span class="toc-text"> 阶段10：Spring应用上下文刷新阶段，由子类实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B511%EF%BC%9ASpring%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%99%A8%E6%B3%A8%E5%86%8C%E9%98%B6%E6%AE%B5"><span class="toc-text"> 阶段11：Spring事件监听器注册阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B512%EF%BC%9A%E5%AE%9E%E4%BE%8B%E5%8C%96%E6%89%80%E6%9C%89%E5%89%A9%E4%BD%99%E7%9A%84%EF%BC%88%E9%9D%9Elazy%20init%EF%BC%89%E5%8D%95%E4%BE%8B"><span class="toc-text"> 阶段12：实例化所有剩余的（非lazy init）单例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B513%EF%BC%9A%E5%88%B7%E6%96%B0%E5%AE%8C%E6%88%90%E9%98%B6%E6%AE%B5"><span class="toc-text"> 阶段13：刷新完成阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%88%E6%9D%A5%E7%9C%8B@2%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text"> 先来看@2的代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B@3%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text"> 再来看@3的代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B@4%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text"> 再来看@4的代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93%E4%B8%8B"><span class="toc-text"> 小结下</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E9%98%B6%E6%AE%B514%EF%BC%9ASpring%E5%BA%94%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E5%85%B3%E9%97%AD%E9%98%B6%E6%AE%B5"><span class="toc-text"> 4、阶段14：Spring应用上下文关闭阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B@1%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text"> 再来看@1的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B@2%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-text"> 再来看@2的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E6%9D%A5%E7%9C%8B@3%E7%9A%84%E4%BB%A3%E7%A0%81-2"><span class="toc-text"> 再来看@3的代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-text"> 5、总结</span></a></li></ol></li>
    </ul>
  </div>
</main>
  <footer id="footer" class="mdui-m-t-5 mdui-p-y-3 mdui-color-theme">
  <div class="mdui-p-y-0 mdui-text-center">
    
      <a href="https://github.com/Lampkins" target="_blank" class="mdui-btn mdui-btn-icon mdui-text-color-theme-a100"><i class="mdui-icon iconfont">&#xe7ab;</i></a>
    
    
      <a href="https://gitee.com/lampkins" target="_blank" class="mdui-btn mdui-btn-icon mdui-text-color-theme-a100"><i class="mdui-icon iconfont1">&#xe686;</i></a>
    
    
    
    
    
    
      <a href="https://www.instagram.com/arimis0" target="_blank" class="mdui-btn mdui-btn-icon mdui-text-color-theme-a100"><i class="mdui-icon iconfont1">&#xe736;</i></a>
    
    
    
    
    
    
      <a href="https://qm.qq.com/cgi-bin/qm/qr?k=g3rAKPWjqKBJ7oezteErpQGrtxISDNmp&noverify=0" target="_blank" class="mdui-btn mdui-btn-icon mdui-text-color-theme-a100"><i class="mdui-icon iconfont">&#xe651;</i></a>
    
    
  </div>
  <div class="mdui-p-y-1 mdui-text-center">
    Copyright &copy; 2019 - 2023 Lampkins<br>
    Powered by <a href="https://hexo.io/" target="_blank" class="mdui-text-color-theme-accent">Hexo</a> | Theme by <a href="https://github.com/niemingzhao/niemingzhao.github.io/tree/theme" target="_blank" class="mdui-text-color-theme-accent">default</a>
    <br>
      <span id="busuanzi_container_site_pv" style="display: none;"><i class="iconfont">&#xe7fd;</i> <span id="busuanzi_value_site_pv"></span></span> &nbsp;&nbsp;
      <span id="busuanzi_container_site_uv" style="display: none;"><i class="iconfont">&#xe601;</i> <span id="busuanzi_value_site_uv"></span></span>
    
  </div>
</footer>
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_upward</i></button>
  <script async src="http://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  
<script src="/js/mdui.js"></script>
<script src="/js/script.js"></script>

  
<script src="/custom.js"></script>

</body>
</html>